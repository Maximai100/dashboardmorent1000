import{r as m,i as R,k as V,l as X,m as Y,n as q,j as e,P as z,S as H,o as W,F as M,L as U,N as G,p as Q,q as Z,s as ee,X as te,T as J,t as K,v as se,C as ae,w as le}from"./index-BglrIO0y.js";import{M as ne}from"./Modal-CGYJv4YG.js";const re=()=>{const[t,i]=m.useState([]),[p,b]=m.useState([]),[y,n]=m.useState(!0),[h,x]=m.useState(null),j=m.useCallback(async()=>{try{n(!0);const l=(await R()).map(r=>({...r,attachments:[]}));i(l);const u=localStorage.getItem("projectOrder");if(u){const r=new Set(l.map(I=>I.id)),P=JSON.parse(u).filter(I=>r.has(I));b(P)}else b(l.map(r=>r.id));x(null)}catch(a){x(a.message||"Failed to fetch projects")}finally{n(!1)}},[]);return m.useEffect(()=>{j()},[j]),m.useEffect(()=>{p.length>0&&localStorage.setItem("projectOrder",JSON.stringify(p))},[p]),{projects:t,projectOrder:p,setProjectOrder:b,loading:y,error:h,addProject:async a=>{try{const l=await q(a);return i(u=>[l,...u]),b(u=>[l.id,...u]),l}catch(l){x(l.message||"Failed to create project");return}},updateProject:async(a,l)=>{try{const u=await Y(a,l);i(r=>r.map(P=>P.id===a?u:P))}catch(u){x(u.message||"Failed to update project")}},deleteProject:async a=>{try{await X(a),i(l=>l.filter(u=>u.id!==a)),b(l=>l.filter(u=>u!==a))}catch(l){x(l.message||"Failed to delete project")}},loadProjectAttachments:async a=>{try{const l=await V(a);return i(u=>u.map(r=>r.id===a?{...r,attachments:l}:r)),l}catch(l){return console.warn(`Failed to load attachments for project ${a}:`,l),[]}}}},ce=({onNewProject:t})=>e.jsxs("header",{className:"mb-6 flex justify-between items-center flex-wrap gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-white",children:"Дашборд руководителя"}),e.jsx("p",{className:"text-sm sm:text-base text-slate-400",children:"Управляйте текущими проектами, задачами и ресурсами."})]}),e.jsx("div",{children:e.jsxs("button",{onClick:t,className:"inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-slate-800",children:[e.jsx(z,{className:"w-5 h-5"}),e.jsx("span",{children:"Новый проект"})]})})]});var C=(t=>(t.InProgress="в работе",t.Completed="завершено",t.Archived="архив",t))(C||{});const ie=({searchText:t,onSearchTextChange:i,statusFilter:p,onStatusFilterChange:b,attachmentFilter:y,onAttachmentFilterChange:n})=>{const h=[{label:"Все",value:"all",icon:e.jsx(W,{className:"w-4 h-4 mr-1.5"})},{label:"Файл",value:"file",icon:e.jsx(M,{className:"w-4 h-4 mr-1.5"})},{label:"Ссылка",value:"link",icon:e.jsx(U,{className:"w-4 h-4 mr-1.5"})},{label:"Нет",value:"none",icon:e.jsx(G,{className:"w-4 h-4 mr-1.5"})}];return e.jsxs("div",{className:"mb-6 p-4 bg-slate-800 rounded-lg flex flex-col sm:flex-row items-center gap-4 flex-wrap",children:[e.jsxs("div",{className:"relative w-full sm:flex-1 sm:min-w-[250px]",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(H,{className:"h-5 w-5 text-slate-400"})}),e.jsx("input",{type:"text",placeholder:"Поиск по проекту или ответственному...",value:t,onChange:x=>i(x.target.value),className:"bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 p-2.5"})]}),e.jsx("div",{className:"w-full sm:w-auto",children:e.jsxs("select",{value:p,onChange:x=>b(x.target.value),className:"bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5",children:[e.jsx("option",{value:"all",children:"Все статусы"}),e.jsx("option",{value:C.InProgress,children:C.InProgress}),e.jsx("option",{value:C.Completed,children:C.Completed}),e.jsx("option",{value:C.Archived,children:C.Archived})]})}),e.jsx("div",{className:"w-full sm:w-auto flex items-center bg-slate-700 rounded-lg p-1 space-x-1",children:h.map(({label:x,value:j,icon:d})=>e.jsxs("button",{onClick:()=>n(j),className:`flex items-center justify-center w-full sm:w-auto px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${y===j?"bg-blue-600 text-white shadow":"text-slate-300 hover:bg-slate-600 hover:text-white"}`,children:[d,x]},j))})]})},oe=({status:t})=>{const i=()=>{switch(t){case C.InProgress:return"bg-sky-500/20 text-sky-400";case C.Completed:return"bg-green-500/20 text-green-400";case C.Archived:return"bg-slate-500/20 text-slate-400";default:return"bg-slate-700 text-slate-300"}};return e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${i()}`,children:t})},de=({project:t,onRowClick:i,isDragged:p,onDragStart:b,onDrop:y})=>{const[n,h]=m.useState(!1),x=new Date(t.deadline)<new Date&&t.status!=="завершено"&&t.status!=="архив",j=a=>{const l=new Date(a),u=String(l.getDate()).padStart(2,"0"),r=String(l.getMonth()+1).padStart(2,"0"),P=l.getFullYear();return`${u}.${r}.${P}`},d=a=>{a.preventDefault(),h(!0)},N=a=>{a.preventDefault(),h(!1)},S=a=>{a.preventDefault(),h(!1),y(t.id)},v=["transition-colors",p?"opacity-30":"hover:bg-slate-700/50",n?"border-t-2 border-blue-500":""].join(" ");return e.jsxs("tr",{draggable:"true",onDragStart:()=>b(t.id),onDragOver:d,onDragLeave:N,onDrop:S,className:v,children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap cursor-pointer",onClick:()=>i(t),children:e.jsx("div",{className:"text-sm font-medium text-white",children:t.name})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-slate-300 cursor-pointer",onClick:()=>i(t),children:t.responsible}),e.jsx("td",{className:`px-6 py-4 whitespace-nowrap text-sm cursor-pointer ${x?"text-red-400 font-bold":"text-slate-300"}`,onClick:()=>i(t),children:j(t.deadline)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap cursor-pointer",onClick:()=>i(t),children:e.jsx(oe,{status:t.status})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap cursor-pointer",onClick:()=>i(t),children:e.jsx("div",{className:"flex flex-wrap items-center gap-1.5",children:t.tags&&t.tags.length>0?t.tags.map(a=>e.jsx("span",{className:"px-2 py-0.5 text-xs rounded bg-slate-700 text-slate-300",children:a},a)):e.jsx("span",{className:"text-slate-500 text-xs",children:"—"})})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-slate-300 cursor-pointer",onClick:()=>i(t),children:!t.attachments||t.attachments.length===0?e.jsx("span",{className:"px-2 py-1 text-xs font-medium rounded bg-red-500/20 text-red-400",children:"Нет вложений"}):e.jsx("div",{className:"flex items-center space-x-2",children:t.attachments.map(a=>a.url?e.jsx("a",{href:a.url,target:"_blank",rel:"noopener noreferrer",title:a.title||a.url,children:e.jsx(U,{className:"w-5 h-5 text-slate-400 hover:text-blue-400"})},a.id):a.directus_files_id?e.jsx("div",{title:a.directus_files_id.title,children:e.jsx(M,{className:"w-5 h-5 text-slate-400"})},a.id):null)})}),e.jsx("td",{className:"px-6 py-4 text-sm text-slate-400 max-w-sm truncate cursor-pointer",onClick:()=>i(t),children:t.notes||"—"})]})},me=({projects:t,onRowClick:i,sortConfig:p,onSort:b,draggedProjectId:y,onDragStart:n,onDrop:h})=>{const x=[{key:"name",label:"ДЕЛО / ПРОЕКТ",isSortable:!0},{key:"responsible",label:"ОТВЕТСТВЕННЫЙ",isSortable:!0},{key:"deadline",label:"ДЕДЛАЙН",isSortable:!0},{key:"status",label:"СТАТУС",isSortable:!0},{key:"tags",label:"ТЕГИ",isSortable:!1},{key:"attachments",label:"ТАБЛИЦА",isSortable:!1},{key:"notes",label:"ПРИМЕЧАНИЯ",isSortable:!1}],j=({columnKey:d})=>p.key!==d?null:p.direction==="asc"?e.jsx(Z,{className:"w-3 h-3 ml-1.5 inline-block"}):e.jsx(ee,{className:"w-3 h-3 ml-1.5 inline-block"});return t.length===0?e.jsxs("div",{className:"text-center py-16 bg-slate-800 rounded-lg shadow-md",children:[e.jsx(Q,{className:"mx-auto h-12 w-12 text-slate-500"}),e.jsx("h3",{className:"mt-2 text-lg font-medium text-white",children:"Проекты не найдены"}),e.jsx("p",{className:"mt-1 text-sm text-slate-400",children:"Попробуйте изменить фильтры или добавить новый проект."})]}):e.jsx("div",{className:"bg-slate-800 shadow-md rounded-lg overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-slate-700",children:[e.jsx("thead",{className:"bg-slate-700/50",children:e.jsx("tr",{children:x.map(({key:d,label:N,isSortable:S})=>e.jsx("th",{scope:"col",className:`px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider whitespace-nowrap ${S?"cursor-pointer hover:text-slate-200":""}`,onClick:()=>S&&b(d),children:e.jsxs("div",{className:"flex items-center",children:[N,S&&e.jsx(j,{columnKey:d})]})},d))})}),e.jsx("tbody",{className:"bg-slate-800 divide-y divide-slate-700",children:t.map(d=>e.jsx(de,{project:d,onRowClick:i,isDragged:y===d.id,onDragStart:n,onDrop:h},d.id))})]})})})},xe=({project:t,onClose:i,onSave:p,onDelete:b})=>{const y={...t,history:t.history||[],tags:t.tags||[],attachments:t.attachments||[],notes:t.notes||""},[n,h]=m.useState(y),[x,j]=m.useState(""),[d,N]=m.useState(!1),S=m.useRef(null);m.useEffect(()=>{const s={...t,history:t.history||[],tags:t.tags||[],attachments:t.attachments||[],notes:t.notes||""};h(s)},[t]);const v=s=>{const{name:c,value:f}=s.target;h(F=>({...F,[c]:f}))},a=s=>{const c=s.target.value;if(c){const f=new Date(n.deadline);f.setFullYear(parseInt(c.substring(0,4),10)),f.setMonth(parseInt(c.substring(5,7),10)-1),f.setDate(parseInt(c.substring(8,10),10)),h(F=>({...F,deadline:f.toISOString()}))}},l=s=>{s.key==="Enter"&&x.trim()!==""&&(s.preventDefault(),(n.tags||[]).includes(x.trim())||h(c=>({...c,tags:[...c.tags||[],x.trim()]})),j(""))},u=s=>{h(c=>({...c,tags:(c.tags||[]).filter(f=>f!==s)}))},r=s=>{h(c=>({...c,attachments:(c.attachments||[]).filter(f=>f.id!==s)}))},P=async s=>{var f;const c=(f=s.target.files)==null?void 0:f[0];if(c)try{N(!0);const F=await le(c),L={id:-1,projects_id:t.id,directus_files_id:F};h($=>({...$,attachments:[...$.attachments||[],L]}))}catch(F){console.error("File upload failed:",F),alert("Не удалось загрузить файл.")}finally{N(!1)}s.target&&(s.target.value="")},I=()=>{const s={...n,attachments:(n.attachments||[]).map(c=>{var f;return(f=c.directus_files_id)==null?void 0:f.id}).filter(c=>!!c)};p(s)},T=()=>{window.confirm(`Вы уверены, что хотите удалить проект "${t.name}"?`)&&b(t.id)},D="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5",E=e.jsxs("div",{className:"flex justify-between w-full",children:[e.jsxs("button",{type:"button",onClick:T,className:"inline-flex items-center gap-2 text-red-400 hover:text-red-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors",children:[e.jsx(J,{className:"w-4 h-4"}),"Удалить проект"]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{type:"button",onClick:i,className:"text-white bg-slate-600 hover:bg-slate-700 border border-slate-500 focus:outline-none focus:ring-4 focus:ring-slate-500 font-medium rounded-lg text-sm px-5 py-2.5",children:"Отмена"}),e.jsx("button",{type:"button",onClick:I,className:"text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5",children:"Сохранить изменения"})]})]});return e.jsx(ne,{title:"Детали проекта",onClose:i,footer:E,children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"name",className:"block mb-2 text-sm font-medium text-white",children:"Название проекта"}),e.jsx("input",{type:"text",id:"name",name:"name",value:n.name,onChange:v,className:D})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"responsible",className:"block mb-2 text-sm font-medium text-white",children:"Ответственный"}),e.jsx("input",{type:"text",id:"responsible",name:"responsible",value:n.responsible,onChange:v,className:D})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"deadline",className:"block mb-2 text-sm font-medium text-white",children:"Дедлайн"}),e.jsx("input",{type:"date",id:"deadline",name:"deadline",value:n.deadline?n.deadline.split("T")[0]:"",onChange:a,className:D})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"status",className:"block mb-2 text-sm font-medium text-white",children:"Статус"}),e.jsx("select",{id:"status",name:"status",value:n.status,onChange:v,className:D,children:Object.values(C).map(s=>e.jsx("option",{value:s,children:s},s))})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"tags",className:"block mb-2 text-sm font-medium text-white",children:"Теги"}),e.jsxs("div",{className:"flex flex-wrap gap-2 items-center p-2 border border-slate-600 rounded-lg bg-slate-700",children:[(n.tags||[]).map(s=>e.jsxs("span",{className:"flex items-center bg-blue-900 text-blue-300 text-xs font-medium px-2 py-1 rounded-full",children:[s,e.jsx("button",{onClick:()=>u(s),className:"ml-1.5 -mr-0.5 p-0.5 rounded-full hover:bg-blue-700",children:e.jsx(te,{className:"w-3 h-3"})})]},s)),e.jsx("input",{type:"text",value:x,onChange:s=>j(s.target.value),onKeyDown:l,placeholder:"Добавить тег...",className:"bg-transparent focus:outline-none flex-grow text-sm min-w-[100px] text-white"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"notes",className:"block mb-2 text-sm font-medium text-white",children:"Заметки"}),e.jsx("textarea",{id:"notes",name:"notes",rows:4,value:n.notes,onChange:v,className:D})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-md font-semibold text-slate-200 mb-2",children:"Вложения"}),n.attachments.length>0&&e.jsx("ul",{className:"border border-slate-700 rounded-lg divide-y divide-slate-700 mb-4",children:n.attachments.map(s=>{var c;return e.jsxs("li",{className:"p-3 flex items-center justify-between hover:bg-slate-700/50",children:[e.jsxs("div",{className:"flex items-center min-w-0",children:[s.url?e.jsx(U,{className:"w-5 h-5 mr-3 text-slate-400 flex-shrink-0"}):e.jsx(M,{className:"w-5 h-5 mr-3 text-slate-400 flex-shrink-0"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-white truncate",children:s.title||((c=s.directus_files_id)==null?void 0:c.title)}),s.directus_files_id&&e.jsxs("p",{className:"text-xs text-slate-400 truncate",children:[s.directus_files_id.type,", ",(s.directus_files_id.filesize/1024).toFixed(2)," KB"]})]})]}),e.jsx("button",{onClick:()=>r(s.id),className:"ml-2 p-1.5 rounded-full hover:bg-red-900/50 text-slate-400 hover:text-red-400",children:e.jsx(J,{className:"w-4 h-4"})})]},s.id)})}),e.jsxs("div",{className:"space-y-3 p-3 bg-slate-700/50 rounded-lg",children:[e.jsx("button",{type:"button",onClick:()=>{var s;return(s=S.current)==null?void 0:s.click()},disabled:d,className:"w-full flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium text-white bg-slate-600 border border-slate-500 rounded-lg shadow-sm hover:bg-slate-500 disabled:bg-slate-500 disabled:cursor-wait",children:d?e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"w-5 h-5 animate-spin"}),e.jsx("span",{children:"Загрузка..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(se,{className:"w-5 h-5"}),e.jsx("span",{children:"Загрузить файл"})]})}),e.jsx("input",{type:"file",ref:S,onChange:P,className:"hidden"})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-md font-semibold text-slate-200 mb-2",children:"История изменений"}),n.history&&n.history.length>0?e.jsx("ul",{className:"space-y-2 text-sm",children:n.history.map(s=>e.jsxs("li",{className:"flex items-center text-slate-400",children:[e.jsx(ae,{className:"w-4 h-4 mr-2 flex-shrink-0"}),new Date(s.timestamp).toLocaleString("ru-RU")," - ",e.jsx("span",{className:"font-medium text-slate-300 mx-1",children:s.user})," - ",s.action]},s.id))}):e.jsx("p",{className:"text-sm text-slate-400 italic",children:"История изменений пока пуста"})]})]})})},fe=()=>{const{projects:t,projectOrder:i,setProjectOrder:p,loading:b,error:y,addProject:n,updateProject:h,deleteProject:x}=re(),[j,d]=m.useState(null),[N,S]=m.useState(()=>localStorage.getItem("projectSearchText")||""),[v,a]=m.useState(()=>localStorage.getItem("projectStatusFilter")||"all"),[l,u]=m.useState(()=>localStorage.getItem("projectAttachmentFilter")||"all"),[r,P]=m.useState(()=>{const g=localStorage.getItem("projectSortConfig");return g?JSON.parse(g):{key:"deadline",direction:"asc"}}),[I,T]=m.useState(null);m.useEffect(()=>{localStorage.setItem("projectSearchText",N),localStorage.setItem("projectStatusFilter",v),localStorage.setItem("projectAttachmentFilter",l),localStorage.setItem("projectSortConfig",JSON.stringify(r))},[N,v,l,r]);const D=m.useMemo(()=>{const g=new Map(t.map(o=>[o.id,o]));let w=i.map(o=>g.get(o)).filter(o=>o!==void 0);const A=new Set(w.map(o=>o.id));t.forEach(o=>{A.has(o.id)||w.push(o)});let k=[...w];if(N){const o=N.toLowerCase();k=k.filter(O=>O.name.toLowerCase().includes(o)||O.responsible.toLowerCase().includes(o)||O.tags&&O.tags.some(_=>_.toLowerCase().includes(o)))}return v!=="all"&&(k=k.filter(o=>o.status===v)),l!=="all"&&(k=k.filter(o=>{switch(l){case"file":return!1;case"link":return!1;case"none":return!0;default:return!0}})),r.key&&k.sort((o,O)=>{const _=o[r.key],B=O[r.key];return _<B?r.direction==="asc"?-1:1:_>B?r.direction==="asc"?1:-1:0}),k},[t,N,v,l,r,i]),E=g=>{let w="asc";r.key===g&&r.direction==="asc"&&(w="desc"),P({key:g,direction:w})},s=async()=>{const g={name:"Новый проект",responsible:"Не назначен",deadline:new Date().toISOString(),attachments:[],notes:""},w=await n(g);w&&d(w)},c=async g=>{const{id:w,...A}=g;await h(w,A),d(null)},f=async g=>{await x(g),d(null)},F=m.useCallback(g=>{T(g)},[]),L=m.useCallback(g=>{if(!I)return;const w=D.map(_=>_.id),A=w.indexOf(I),k=w.indexOf(g);if(A===-1||k===-1)return;const o=[...w],[O]=o.splice(A,1);o.splice(k,0,O),P({key:null,direction:"asc"}),p(o),T(null)},[I,D,p]),$=()=>b?e.jsxs("div",{className:"flex justify-center items-center h-64",children:[e.jsx(K,{className:"w-8 h-8 animate-spin text-blue-500"}),e.jsx("p",{className:"ml-4 text-slate-400",children:"Загрузка проектов..."})]}):y?e.jsxs("div",{className:"text-center py-16 bg-red-900/20 border border-red-500/30 rounded-lg",children:[e.jsx("h3",{className:"text-lg font-medium text-red-400",children:"Ошибка при загрузке проектов"}),e.jsx("p",{className:"mt-1 text-sm text-slate-400",children:y}),e.jsx("p",{className:"mt-2 text-xs text-slate-500",children:"Убедитесь, что Directus запущен и конфигурация в `config.ts` верна."})]}):e.jsx(me,{projects:D,onRowClick:d,sortConfig:r,onSort:E,draggedProjectId:I,onDragStart:F,onDrop:L});return e.jsxs("div",{children:[e.jsx(ce,{onNewProject:s}),e.jsxs("main",{children:[e.jsx(ie,{searchText:N,onSearchTextChange:S,statusFilter:v,onStatusFilterChange:a,attachmentFilter:l,onAttachmentFilterChange:u}),$()]}),j&&e.jsx(xe,{project:j,onClose:()=>d(null),onSave:c,onDelete:f})]})};export{fe as default};
