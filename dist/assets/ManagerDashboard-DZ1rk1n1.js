import{r as p,m as ae,n as H,o as re,p as ne,q as ie,j as e,P as oe,s as ce,t as de,F as Y,L as z,N as me,e as W,f as Z,v as ue,w as he,x as xe,X as fe,T as G,S as ee,y as ge,C as pe,d as be}from"./index-GhTv4f3B.js";import{M as je}from"./Modal-C9LOwrDm.js";var P=(t=>(t.InProgress="в работе",t.Completed="завершено",t.Archived="архив",t))(P||{});const we=t=>{if(t==null)return null;if(typeof t=="string"){try{const n=JSON.parse(t);if(typeof n=="string")return n}catch{if(Object.values(P).includes(t))return t}return null}return t},te=(t,n)=>t?t.map(c=>{if(typeof c=="number"||typeof c=="string"){const m=Number(c);return{id:Number.isNaN(m)?-1:m,projects_id:n,url:void 0}}const w=c.url??(typeof c.URL=="string"?c.URL:void 0),a=c.projects_id??(()=>{const m=Number(n);return Number.isNaN(m)?n:m})();return{...c,projects_id:a,url:w}}):[],X=t=>({...t,tags:t.tags??[],attachments:te(t.attachments,t.id),history:t.history??[],notes:t.notes??"",director_comment:t.director_comment??"",status:we(t.status??null)}),Ne=()=>{const[t,n]=p.useState([]),[c,w]=p.useState([]),[a,m]=p.useState(!0),[y,N]=p.useState(null),_=p.useCallback(async()=>{try{m(!0);const x=await ae(),h=x.map(X);n(h);const r=localStorage.getItem("projectOrder");if(r){const i=new Set(x.map(g=>g.id)),k=JSON.parse(r).filter(g=>i.has(g));w(k)}else w(x.map(i=>i.id));N(null)}catch(x){N(x.message||"Failed to fetch projects")}finally{m(!1)}},[]);return p.useEffect(()=>{_()},[_]),p.useEffect(()=>{c.length>0&&localStorage.setItem("projectOrder",JSON.stringify(c))},[c]),{projects:t,projectOrder:c,setProjectOrder:w,loading:a,error:y,addProject:async x=>{try{const h=await ie(x),r=X(h);return n(i=>[r,...i]),w(i=>[r.id,...i]),r}catch(h){N(h.message||"Failed to create project");return}},updateProject:async(x,h)=>{var r;try{console.log("📤 Отправка обновления проекта:",{id:x,attachments:h.attachments});const i=await ne(x,h);if(console.log("📥 Получен ответ от Directus:",{attachmentsCount:(r=i.attachments)==null?void 0:r.length,attachments:i.attachments}),!i.attachments||i.attachments.some(v=>!!(!v||typeof v=="number"||typeof v=="string"||v.directus_files_id&&typeof v.directus_files_id=="string"))){console.log("🔄 Загрузка полных данных attachments...");const v=await H(x);console.log("✅ Загружено attachments:",v.length),i.attachments=v}const g=X(i);console.log("✅ Проект обновлен:",{id:g.id,attachmentsCount:g.attachments.length}),n(v=>v.map(F=>F.id===x?g:F))}catch(i){console.error("❌ Failed to update project",i),N(i.message||"Failed to update project")}},deleteProject:async x=>{try{await re(x),n(h=>h.filter(r=>r.id!==x)),w(h=>h.filter(r=>r!==x))}catch(h){N(h.message||"Failed to delete project")}},loadProjectAttachments:async x=>{try{const h=await H(x),r=te(h,x);return n(i=>i.map(k=>k.id===x?{...k,attachments:r}:k)),r}catch(h){return console.warn(`Failed to load attachments for project ${x}:`,h),[]}}}},ye=({onNewProject:t})=>e.jsxs("header",{className:"mb-6 flex justify-between items-center flex-wrap gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-white",children:"Дашборд руководителя"}),e.jsx("p",{className:"text-sm sm:text-base text-slate-400",children:"Управляйте текущими задачами и ресурсами."})]}),e.jsx("div",{children:e.jsxs("button",{onClick:t,className:"inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-slate-800",children:[e.jsx(oe,{className:"w-5 h-5"}),e.jsx("span",{children:"Новая задача"})]})})]}),ve=({searchText:t,onSearchTextChange:n,statusFilter:c,onStatusFilterChange:w,attachmentFilter:a,onAttachmentFilterChange:m})=>{const y=[{label:"Все",value:"all",icon:e.jsx(de,{className:"w-4 h-4 mr-1.5"})},{label:"Файл",value:"file",icon:e.jsx(Y,{className:"w-4 h-4 mr-1.5"})},{label:"Ссылка",value:"link",icon:e.jsx(z,{className:"w-4 h-4 mr-1.5"})},{label:"Нет",value:"none",icon:e.jsx(me,{className:"w-4 h-4 mr-1.5"})}];return e.jsxs("div",{className:"mb-6 p-4 bg-slate-800 rounded-lg flex flex-col sm:flex-row items-center gap-4 flex-wrap",children:[e.jsxs("div",{className:"relative w-full sm:flex-1 sm:min-w-[250px]",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(ce,{className:"h-5 w-5 text-slate-400"})}),e.jsx("input",{type:"text",placeholder:"Поиск по задаче или ответственному...",value:t,onChange:N=>n(N.target.value),className:"bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 p-2.5"})]}),e.jsx("div",{className:"w-full sm:w-auto",children:e.jsxs("select",{value:c,onChange:N=>w(N.target.value),className:"bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5",children:[e.jsx("option",{value:"all",children:"Все статусы"}),e.jsx("option",{value:P.InProgress,children:P.InProgress}),e.jsx("option",{value:P.Completed,children:P.Completed}),e.jsx("option",{value:P.Archived,children:P.Archived})]})}),e.jsx("div",{className:"w-full sm:w-auto flex items-center bg-slate-700 rounded-lg p-1 space-x-1",children:y.map(({label:N,value:_,icon:j})=>e.jsxs("button",{onClick:()=>m(_),className:`flex items-center justify-center w-full sm:w-auto px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${a===_?"bg-blue-600 text-white shadow":"text-slate-300 hover:bg-slate-600 hover:text-white"}`,children:[j,N]},_))})]})},Se=({status:t})=>{const n=()=>{switch(t){case P.InProgress:return"bg-sky-500/20 text-sky-400";case P.Completed:return"bg-green-500/20 text-green-400";case P.Archived:return"bg-slate-500/20 text-slate-400";default:return"bg-slate-700 text-slate-300"}},c=t??"—";return e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${n()}`,children:c})},_e=({project:t,onRowClick:n,isDragged:c,onDragStart:w,onDrop:a})=>{const[m,y]=p.useState(!1),N=t.status===P.Completed,_=t.status===P.Archived,j=new Date(t.deadline)<new Date&&!N&&!_,S=r=>{const i=new Date(r),k=String(i.getDate()).padStart(2,"0"),g=String(i.getMonth()+1).padStart(2,"0"),v=i.getFullYear();return`${k}.${g}.${v}`},D=r=>{r.preventDefault(),y(!0)},A=r=>{r.preventDefault(),y(!1)},x=r=>{r.preventDefault(),y(!1),a(t.id)},h=["transition-colors",c?"opacity-30":"hover:bg-slate-700/50",m?"border-t-2 border-blue-500":""].join(" ");return e.jsxs("tr",{draggable:"true",onDragStart:()=>w(t.id),onDragOver:D,onDragLeave:A,onDrop:x,className:h,children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap cursor-pointer",onClick:()=>n(t),children:e.jsx("div",{className:"text-sm font-medium text-white",children:t.name})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-slate-300 cursor-pointer",onClick:()=>n(t),children:t.responsible}),e.jsx("td",{className:`px-6 py-4 whitespace-nowrap text-sm cursor-pointer ${j?"text-red-400 font-bold":"text-slate-300"}`,onClick:()=>n(t),children:S(t.deadline)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap cursor-pointer",onClick:()=>n(t),children:e.jsx(Se,{status:t.status})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap cursor-pointer",onClick:()=>n(t),children:e.jsx("div",{className:"flex flex-wrap items-center gap-1.5",children:t.tags&&t.tags.length>0?t.tags.map(r=>e.jsx("span",{className:"px-2 py-0.5 text-xs rounded bg-slate-700 text-slate-300",children:r},r)):e.jsx("span",{className:"text-slate-500 text-xs",children:"—"})})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-slate-300 cursor-pointer",onClick:()=>n(t),children:!t.attachments||t.attachments.length===0?e.jsx("span",{className:"px-2 py-1 text-xs font-medium rounded bg-red-500/20 text-red-400",children:"Нет вложений"}):e.jsx("div",{className:"flex items-center space-x-2",children:(t.attachments||[]).map(r=>{const i=r.URL||r.url,k=r.title;if(i)return e.jsx("a",{href:i,target:"_blank",rel:"noopener noreferrer",title:k||i,onClick:g=>g.stopPropagation(),children:e.jsx(z,{className:"w-5 h-5 text-slate-400 hover:text-blue-400"})},r.id);if(r.directus_files_id){const g=typeof r.directus_files_id=="object"?r.directus_files_id:null,v=typeof r.directus_files_id=="string"?r.directus_files_id:g==null?void 0:g.id,F=v?`${W}/assets/${v}?access_token=${Z}`:"#",$=(g==null?void 0:g.title)||"Файл";return e.jsx("a",{href:F,target:"_blank",rel:"noopener noreferrer",title:$,onClick:U=>U.stopPropagation(),children:e.jsx(Y,{className:"w-5 h-5 text-slate-400 hover:text-blue-400"})},r.id)}return null})})}),e.jsx("td",{className:"px-6 py-4 text-sm text-slate-400 max-w-sm truncate cursor-pointer",onClick:()=>n(t),children:t.notes||"—"}),e.jsx("td",{className:"px-6 py-4 text-sm text-slate-300 max-w-xs truncate cursor-pointer",onClick:()=>n(t),children:t.director_comment?t.director_comment:"—"})]})},ke=({projects:t,onRowClick:n,sortConfig:c,onSort:w,draggedProjectId:a,onDragStart:m,onDrop:y})=>{const N=[{key:"name",label:"ДЕЛО / ЗАДАЧА",isSortable:!0},{key:"responsible",label:"ОТВЕТСТВЕННЫЙ",isSortable:!0},{key:"deadline",label:"ДЕДЛАЙН",isSortable:!0},{key:"status",label:"СТАТУС",isSortable:!0},{key:"tags",label:"ТЕГИ",isSortable:!1},{key:"attachments",label:"ТАБЛИЦА",isSortable:!1},{key:"notes",label:"ПРИМЕЧАНИЯ",isSortable:!1},{key:"director_comment",label:"КОММЕНТАРИЙ РУКОВОДИТЕЛЯ",isSortable:!1}],_=({columnKey:j})=>c.key!==j?null:c.direction==="asc"?e.jsx(he,{className:"w-3 h-3 ml-1.5 inline-block"}):e.jsx(xe,{className:"w-3 h-3 ml-1.5 inline-block"});return t.length===0?e.jsxs("div",{className:"text-center py-16 bg-slate-800 rounded-lg shadow-md",children:[e.jsx(ue,{className:"mx-auto h-12 w-12 text-slate-500"}),e.jsx("h3",{className:"mt-2 text-lg font-medium text-white",children:"Задачи не найдены"}),e.jsx("p",{className:"mt-1 text-sm text-slate-400",children:"Попробуйте изменить фильтры или добавить новую задачу."})]}):e.jsx("div",{className:"bg-slate-800 shadow-md rounded-lg overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-slate-700",children:[e.jsx("thead",{className:"bg-slate-700/50",children:e.jsx("tr",{children:N.map(({key:j,label:S,isSortable:D})=>e.jsx("th",{scope:"col",className:`px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider whitespace-nowrap ${D?"cursor-pointer hover:text-slate-200":""}`,onClick:()=>D&&w(j),children:e.jsxs("div",{className:"flex items-center",children:[S,D&&e.jsx(_,{columnKey:j})]})},j))})}),e.jsx("tbody",{className:"bg-slate-800 divide-y divide-slate-700",children:t.map(j=>e.jsx(_e,{project:j,onRowClick:n,isDragged:a===j.id,onDragStart:m,onDrop:y},j.id))})]})})})},Ce=t=>{if(t==null)return null;if(typeof t=="string"){try{const n=JSON.parse(t);if(typeof n=="string")return n}catch{if(Object.values(P).includes(t))return t}return null}return t},Pe=(t,n)=>{if(!t)return[];const c=Number(n),w=Number.isNaN(c)?n:c;return t.map(a=>{if(typeof a=="number"||typeof a=="string"){const y=Number(a);return{id:Number.isNaN(y)?-1:y,projects_id:w,url:void 0}}const m=a.url??(typeof a.URL=="string"?a.URL:void 0);return{...a,projects_id:a.projects_id??w,url:m}})},Q=t=>({...t,tags:t.tags??[],attachments:Pe(t.attachments,t.id),history:t.history??[],notes:t.notes??"",director_comment:t.director_comment??"",status:Ce(t.status??null)}),Ie=(t=[],n=[])=>{if(t.length!==n.length)return!1;const c=[...t].sort(),w=[...n].sort();return c.every((a,m)=>a===w[m])},De=({project:t,onClose:n,onSave:c,onDelete:w})=>{var R;const[a,m]=p.useState(()=>Q(t)),[y,N]=p.useState(""),[_,j]=p.useState(!1),[S,D]=p.useState({url:"",title:""}),[A,x]=p.useState(!1),h=p.useRef(null);p.useEffect(()=>{m(Q(t))},[t]);const r=s=>{const{name:l,value:f}=s.target;if(l==="status"){m(d=>({...d,status:f||null}));return}m(d=>({...d,[l]:f}))},i=s=>{const l=s.target.value;if(l){const f=new Date(a.deadline);f.setFullYear(parseInt(l.substring(0,4),10)),f.setMonth(parseInt(l.substring(5,7),10)-1),f.setDate(parseInt(l.substring(8,10),10)),m(d=>({...d,deadline:f.toISOString()}))}},k=s=>{s.key==="Enter"&&y.trim()!==""&&(s.preventDefault(),a.tags.includes(y.trim())||m(l=>({...l,tags:[...l.tags,y.trim()]})),N(""))},g=s=>{m(l=>({...l,tags:l.tags.filter(f=>f!==s)}))},v=s=>{console.log("🗑️ Удаление attachment из локального состояния:",{id:s}),m(l=>{var d;const f=(l.attachments||[]).filter(o=>o.id!==s);return console.log(`   Было: ${((d=l.attachments)==null?void 0:d.length)||0}, стало: ${f.length}`),{...l,attachments:f}})},F=async s=>{var f;const l=(f=s.target.files)==null?void 0:f[0];if(l)try{x(!0);const d=await be(l),o={id:Date.now()*-1,projects_id:t.id,directus_files_id:d,title:d.title||l.name};m(b=>({...b,attachments:[...b.attachments||[],o]}))}catch(d){console.error("File upload failed:",d),alert("Не удалось загрузить файл.")}finally{x(!1)}s.target&&(s.target.value="")},$=()=>{if(!S.url.trim())return;const s={id:Date.now()*-1,projects_id:t.id,url:S.url.trim(),title:S.title.trim()||S.url.trim()};m(l=>({...l,attachments:[...l.attachments||[],s]})),D({url:"",title:""}),j(!1)},U=()=>{const s=y.trim(),l=a.tags??[],f=s&&!l.includes(s)?[...l,s]:l;s&&!l.includes(s)&&(m(u=>({...u,tags:f})),N(""));const d=new Set((t.attachments||[]).map(u=>u.id)),o=new Set((a.attachments||[]).map(u=>u.id));console.log("🔍 Анализ attachments:",{original:Array.from(d),current:Array.from(o),deleted:Array.from(d).filter(u=>!o.has(u))});const b=[];(a.attachments||[]).forEach(u=>{u.id>0&&(b.push({id:u.id}),console.log("📎 Сохраняем существующий attachment:",{id:u.id}))}),(a.attachments||[]).forEach(u=>{if(u.id<0){if(!u.directus_files_id&&(!u.url||u.url.trim()===""))return;const L={projects_id:t.id};if(u.url&&u.url.trim()!==""&&(L.URL=u.url.trim(),u.title&&u.title.trim()!==""&&(L.title=u.title.trim()),console.log("🔗 Сохранение ссылки:",{URL:L.URL,title:L.title})),u.directus_files_id){const le=typeof u.directus_files_id=="string"?u.directus_files_id:u.directus_files_id.id;L.directus_files_id=le,u.title&&(L.title=u.title)}console.log("📎 Добавляем новый attachment:",L),b.push(L)}});const I=Array.from(d).filter(u=>!o.has(u)&&u>0);I.length>0&&console.log("📎 Будут удалены attachments (не включены в список):",I);const C=t.tags??[],E=f,K=!Ie(C,E),M=t.status??null,q=a.status??null,se=M!==q,V={id:t.id,name:a.name,responsible:a.responsible,deadline:a.deadline,notes:a.notes??"",director_comment:a.director_comment??"",attachments:b};K&&(V.tags=E),se&&(V.status=q?JSON.stringify(q):null),console.log("💾 Сохранение задачи:",{projectId:t.id,attachmentsCount:b.length,attachments:b}),c(V)},J=()=>{window.confirm(`Вы уверены, что хотите удалить задачу "${t.name}"?`)&&w(t.id)},O="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5",B=e.jsxs("div",{className:"flex justify-between w-full",children:[e.jsxs("button",{type:"button",onClick:J,className:"inline-flex items-center gap-2 text-red-400 hover:text-red-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors",children:[e.jsx(G,{className:"w-4 h-4"}),"Удалить задачу"]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{type:"button",onClick:n,className:"text-white bg-slate-600 hover:bg-slate-700 border border-slate-500 focus:outline-none focus:ring-4 focus:ring-slate-500 font-medium rounded-lg text-sm px-5 py-2.5",children:"Отмена"}),e.jsx("button",{type:"button",onClick:U,className:"text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5",children:"Сохранить изменения"})]})]}),T=(a.attachments||[]).filter(s=>s.directus_files_id||s.url||s.URL);return console.log(`🖼️ Отображение attachments для задачи "${t.name}":`,{total:((R=a.attachments)==null?void 0:R.length)||0,valid:T.length,attachments:T.map(s=>({id:s.id,hasFile:!!s.directus_files_id,fileType:typeof s.directus_files_id,hasUrl:!!s.url,title:s.title}))}),e.jsx(je,{title:"Детали задачи",onClose:n,footer:B,children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"name",className:"block mb-2 text-sm font-medium text-white",children:"Название задачи"}),e.jsx("input",{type:"text",id:"name",name:"name",value:a.name,onChange:r,className:O})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"responsible",className:"block mb-2 text-sm font-medium text-white",children:"Ответственный"}),e.jsx("input",{type:"text",id:"responsible",name:"responsible",value:a.responsible,onChange:r,className:O})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"deadline",className:"block mb-2 text-sm font-medium text-white",children:"Дедлайн"}),e.jsx("input",{type:"date",id:"deadline",name:"deadline",value:a.deadline.split("T")[0],onChange:i,className:O})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"status",className:"block mb-2 text-sm font-medium text-white",children:"Статус"}),e.jsxs("select",{id:"status",name:"status",value:a.status??"",onChange:r,className:O,children:[e.jsx("option",{value:"",children:"Без статуса"}),Object.values(P).map(s=>e.jsx("option",{value:s,children:s},s))]})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"tags",className:"block mb-2 text-sm font-medium text-white",children:"Теги"}),e.jsxs("div",{className:"flex flex-wrap gap-2 items-center p-2 border border-slate-600 rounded-lg bg-slate-700",children:[a.tags.map(s=>e.jsxs("span",{className:"flex items-center bg-blue-900 text-blue-300 text-xs font-medium px-2 py-1 rounded-full",children:[s,e.jsx("button",{onClick:()=>g(s),className:"ml-1.5 -mr-0.5 p-0.5 rounded-full hover:bg-blue-700",children:e.jsx(fe,{className:"w-3 h-3"})})]},s)),e.jsx("input",{type:"text",value:y,onChange:s=>N(s.target.value),onKeyDown:k,placeholder:"Добавить тег...",className:"bg-transparent focus:outline-none flex-grow text-sm min-w-[100px] text-white"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"notes",className:"block mb-2 text-sm font-medium text-white",children:"Заметки"}),e.jsx("textarea",{id:"notes",name:"notes",rows:4,value:a.notes,onChange:r,className:O})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"director_comment",className:"block mb-2 text-sm font-medium text-white",children:"Комментарий руководителя"}),e.jsx("textarea",{id:"director_comment",name:"director_comment",rows:3,value:a.director_comment,onChange:r,className:O,placeholder:"Добавьте комментарий для команды..."})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-md font-semibold text-slate-200 mb-2",children:"Вложения"}),T.length>0&&e.jsx("ul",{className:"border border-slate-700 rounded-lg divide-y divide-slate-700 mb-4",children:T.map(s=>{var M;const l=s.URL||s.url,f=!!l,d=!!s.directus_files_id,o=typeof s.directus_files_id=="string"?s.directus_files_id:(M=s.directus_files_id)==null?void 0:M.id,b=d&&o?`${W}/assets/${o}?access_token=${Z}`:"#",I=l||b,C=typeof s.directus_files_id=="object"?s.directus_files_id:null,E=s.title||(C==null?void 0:C.title)||"Файл",K=d&&C?`${C.type||"файл"}, ${((C.filesize||0)/1024).toFixed(2)} KB`:l;return e.jsxs("li",{className:"p-3 flex items-center justify-between hover:bg-slate-700/50",children:[e.jsxs("a",{href:I,target:"_blank",rel:"noopener noreferrer",className:"flex items-center min-w-0 flex-grow group",title:E,children:[f?e.jsx(z,{className:"w-5 h-5 mr-3 text-slate-400 flex-shrink-0"}):e.jsx(Y,{className:"w-5 h-5 mr-3 text-slate-400 flex-shrink-0"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-white truncate group-hover:text-blue-400 transition-colors",children:E}),e.jsx("p",{className:"text-xs text-slate-400 truncate",children:K})]})]}),e.jsx("button",{onClick:()=>v(s.id),className:"ml-4 p-1.5 rounded-full hover:bg-red-900/50 text-slate-400 hover:text-red-400 flex-shrink-0",title:"Удалить вложение",children:e.jsx(G,{className:"w-4 h-4"})})]},s.id)})}),e.jsxs("div",{className:"space-y-3 p-3 bg-slate-700/50 rounded-lg",children:[e.jsx("button",{type:"button",onClick:()=>{var s;return(s=h.current)==null?void 0:s.click()},disabled:A,className:"w-full flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium text-white bg-slate-600 border border-slate-500 rounded-lg shadow-sm hover:bg-slate-500 disabled:bg-slate-500 disabled:cursor-wait",children:A?e.jsxs(e.Fragment,{children:[e.jsx(ee,{className:"w-5 h-5 animate-spin"}),e.jsx("span",{children:"Загрузка..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(ge,{className:"w-5 h-5"}),e.jsx("span",{children:"Загрузить файл"})]})}),e.jsx("input",{type:"file",ref:h,onChange:F,className:"hidden"}),e.jsxs("button",{type:"button",onClick:()=>j(!_),className:"w-full flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium text-white bg-slate-600 border border-slate-500 rounded-lg shadow-sm hover:bg-slate-500",children:[e.jsx(z,{className:"w-5 h-5"}),e.jsx("span",{children:_?"Отменить":"Добавить ссылку"})]}),_&&e.jsxs("div",{className:"pt-3 border-t border-slate-600 space-y-3",children:[e.jsx("input",{type:"url",placeholder:"https://example.com/document",value:S.url,onChange:s=>D(l=>({...l,url:s.target.value})),className:O}),e.jsx("input",{type:"text",placeholder:"Название (необязательно)",value:S.title,onChange:s=>D(l=>({...l,title:s.target.value})),className:O}),e.jsx("button",{type:"button",onClick:$,disabled:!S.url.trim(),className:"w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 disabled:bg-blue-500 disabled:cursor-not-allowed",children:"Сохранить ссылку"})]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-md font-semibold text-slate-200 mb-2",children:"История изменений"}),e.jsx("ul",{className:"space-y-2 text-sm",children:a.history.map(s=>e.jsxs("li",{className:"flex items-center text-slate-400",children:[e.jsx(pe,{className:"w-4 h-4 mr-2 flex-shrink-0"}),new Date(s.timestamp).toLocaleString("ru-RU")," - ",e.jsx("span",{className:"font-medium text-slate-300 mx-1",children:s.user})," - ",s.action]},s.id))})]})]})})},Oe=()=>{const{projects:t,projectOrder:n,setProjectOrder:c,loading:w,error:a,addProject:m,updateProject:y,deleteProject:N}=Ne(),[_,j]=p.useState(null),[S,D]=p.useState(()=>localStorage.getItem("projectSearchText")||""),[A,x]=p.useState(()=>localStorage.getItem("projectStatusFilter")||"all"),[h,r]=p.useState(()=>localStorage.getItem("projectAttachmentFilter")||"all"),[i,k]=p.useState(()=>{const s=localStorage.getItem("projectSortConfig");return s?JSON.parse(s):{key:"deadline",direction:"asc"}}),[g,v]=p.useState(null);p.useEffect(()=>{localStorage.setItem("projectSearchText",S),localStorage.setItem("projectStatusFilter",A),localStorage.setItem("projectAttachmentFilter",h),localStorage.setItem("projectSortConfig",JSON.stringify(i))},[S,A,h,i]);const F=p.useMemo(()=>{const s=new Map(t.map(o=>[o.id,o]));let l=n.map(o=>s.get(o)).filter(o=>o!==void 0);const f=new Set(l.map(o=>o.id));t.forEach(o=>{f.has(o.id)||l.push(o)});let d=[...l];if(S){const o=S.toLowerCase();d=d.filter(b=>b.name.toLowerCase().includes(o)||b.responsible.toLowerCase().includes(o)||b.tags&&b.tags.length>0&&b.tags.some(I=>I.toLowerCase().includes(o)))}return A!=="all"&&(d=d.filter(o=>o.status===A)),h!=="all"&&(d=d.filter(o=>{const b=o.attachments||[],I=b.length>0;switch(h){case"file":return b.some(C=>C.directus_files_id);case"link":return b.some(C=>C.url);case"none":return!I;default:return!0}})),i.key&&d.sort((o,b)=>{const I=o[i.key],C=b[i.key];return I<C?i.direction==="asc"?-1:1:I>C?i.direction==="asc"?1:-1:0}),d},[t,S,A,h,i,n]),$=s=>{let l="asc";i.key===s&&i.direction==="asc"&&(l="desc"),k({key:s,direction:l})},U=async()=>{const s={name:"Новая задача",responsible:"Не назначен",deadline:new Date().toISOString(),attachments:[],notes:"",director_comment:"",tags:[],history:[]},l=await m(s);l&&j(l)},J=async s=>{const{id:l,...f}=s;await y(l,f),j(null)},O=async s=>{await N(s),j(null)},B=p.useCallback(s=>{v(s)},[]),T=p.useCallback(s=>{if(!g)return;const l=F.map(I=>I.id),f=l.indexOf(g),d=l.indexOf(s);if(f===-1||d===-1)return;const o=[...l],[b]=o.splice(f,1);o.splice(d,0,b),k({key:null,direction:"asc"}),c(o),v(null)},[g,F,c]),R=()=>w?e.jsxs("div",{className:"flex justify-center items-center h-64",children:[e.jsx(ee,{className:"w-8 h-8 animate-spin text-blue-500"}),e.jsx("p",{className:"ml-4 text-slate-400",children:"Загрузка задач..."})]}):a?e.jsxs("div",{className:"text-center py-16 bg-red-900/20 border border-red-500/30 rounded-lg",children:[e.jsx("h3",{className:"text-lg font-medium text-red-400",children:"Ошибка при загрузке задач"}),e.jsx("p",{className:"mt-1 text-sm text-slate-400",children:a}),e.jsx("p",{className:"mt-2 text-xs text-slate-500",children:"Убедитесь, что Directus запущен и конфигурация в `config.ts` верна."})]}):e.jsx(ke,{projects:F,onRowClick:j,sortConfig:i,onSort:$,draggedProjectId:g,onDragStart:B,onDrop:T});return e.jsxs("div",{children:[e.jsx(ye,{onNewProject:U}),e.jsxs("main",{children:[e.jsx(ve,{searchText:S,onSearchTextChange:D,statusFilter:A,onStatusFilterChange:x,attachmentFilter:h,onAttachmentFilterChange:r}),R()]}),_&&e.jsx(De,{project:_,onClose:()=>j(null),onSave:J,onDelete:O})]})};export{Oe as default};
