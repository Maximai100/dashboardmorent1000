import{r as x,i as V,k as X,l as Y,m as q,n as z,j as e,P as H,S as G,o as Q,F as B,L as J,N as W,p as Z,q as ee,s as te,X as se,T as K,t as R,v as ae,C as le,w as ne}from"./index-5E1p-adu.js";import{M as re}from"./Modal-BaQ7haaK.js";const ce=()=>{const[t,i]=x.useState([]),[p,j]=x.useState([]),[S,r]=x.useState(!0),[h,u]=x.useState(null),b=x.useCallback(async()=>{try{r(!0);const a=await V();i(a);const l=localStorage.getItem("projectOrder");if(l){const d=new Set(a.map(y=>y.id)),m=JSON.parse(l).filter(y=>d.has(y));j(m)}else j(a.map(d=>d.id));u(null)}catch(a){u(a.message||"Failed to fetch projects")}finally{r(!1)}},[]);return x.useEffect(()=>{b()},[b]),x.useEffect(()=>{p.length>0&&localStorage.setItem("projectOrder",JSON.stringify(p))},[p]),{projects:t,projectOrder:p,setProjectOrder:j,loading:S,error:h,addProject:async a=>{try{const l=await z(a);return i(d=>[l,...d]),j(d=>[l.id,...d]),l}catch(l){u(l.message||"Failed to create project");return}},updateProject:async(a,l)=>{try{const d=await q(a,l);i(m=>m.map(y=>y.id===a?d:y))}catch(d){u(d.message||"Failed to update project")}},deleteProject:async a=>{try{await Y(a),i(l=>l.filter(d=>d.id!==a)),j(l=>l.filter(d=>d!==a))}catch(l){u(l.message||"Failed to delete project")}},loadProjectAttachments:async a=>{try{const l=await X(a);return i(d=>d.map(m=>m.id===a?{...m,attachments:l}:m)),l}catch(l){return console.warn(`Failed to load attachments for project ${a}:`,l),[]}}}},ie=({onNewProject:t})=>e.jsxs("header",{className:"mb-6 flex justify-between items-center flex-wrap gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-white",children:"Дашборд руководителя"}),e.jsx("p",{className:"text-sm sm:text-base text-slate-400",children:"Управляйте текущими проектами, задачами и ресурсами."})]}),e.jsx("div",{children:e.jsxs("button",{onClick:t,className:"inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-slate-800",children:[e.jsx(H,{className:"w-5 h-5"}),e.jsx("span",{children:"Новый проект"})]})})]});var C=(t=>(t.InProgress="в работе",t.Completed="завершено",t.Archived="архив",t))(C||{});const oe=({searchText:t,onSearchTextChange:i,statusFilter:p,onStatusFilterChange:j,attachmentFilter:S,onAttachmentFilterChange:r})=>{const h=[{label:"Все",value:"all",icon:e.jsx(Q,{className:"w-4 h-4 mr-1.5"})},{label:"Файл",value:"file",icon:e.jsx(B,{className:"w-4 h-4 mr-1.5"})},{label:"Ссылка",value:"link",icon:e.jsx(J,{className:"w-4 h-4 mr-1.5"})},{label:"Нет",value:"none",icon:e.jsx(W,{className:"w-4 h-4 mr-1.5"})}];return e.jsxs("div",{className:"mb-6 p-4 bg-slate-800 rounded-lg flex flex-col sm:flex-row items-center gap-4 flex-wrap",children:[e.jsxs("div",{className:"relative w-full sm:flex-1 sm:min-w-[250px]",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(G,{className:"h-5 w-5 text-slate-400"})}),e.jsx("input",{type:"text",placeholder:"Поиск по проекту или ответственному...",value:t,onChange:u=>i(u.target.value),className:"bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 p-2.5"})]}),e.jsx("div",{className:"w-full sm:w-auto",children:e.jsxs("select",{value:p,onChange:u=>j(u.target.value),className:"bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5",children:[e.jsx("option",{value:"all",children:"Все статусы"}),e.jsx("option",{value:C.InProgress,children:C.InProgress}),e.jsx("option",{value:C.Completed,children:C.Completed}),e.jsx("option",{value:C.Archived,children:C.Archived})]})}),e.jsx("div",{className:"w-full sm:w-auto flex items-center bg-slate-700 rounded-lg p-1 space-x-1",children:h.map(({label:u,value:b,icon:o})=>e.jsxs("button",{onClick:()=>r(b),className:`flex items-center justify-center w-full sm:w-auto px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${S===b?"bg-blue-600 text-white shadow":"text-slate-300 hover:bg-slate-600 hover:text-white"}`,children:[o,u]},b))})]})},de=({status:t})=>{const i=()=>{switch(t){case C.InProgress:return"bg-sky-500/20 text-sky-400";case C.Completed:return"bg-green-500/20 text-green-400";case C.Archived:return"bg-slate-500/20 text-slate-400";default:return"bg-slate-700 text-slate-300"}};return e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${i()}`,children:t})},me=({project:t,onRowClick:i,isDragged:p,onDragStart:j,onDrop:S})=>{const[r,h]=x.useState(!1),u=new Date(t.deadline)<new Date&&t.status!=="завершено"&&t.status!=="архив",b=a=>{const l=new Date(a),d=String(l.getDate()).padStart(2,"0"),m=String(l.getMonth()+1).padStart(2,"0"),y=l.getFullYear();return`${d}.${m}.${y}`},o=a=>{a.preventDefault(),h(!0)},N=a=>{a.preventDefault(),h(!1)},k=a=>{a.preventDefault(),h(!1),S(t.id)},v=["transition-colors",p?"opacity-30":"hover:bg-slate-700/50",r?"border-t-2 border-blue-500":""].join(" ");return e.jsxs("tr",{draggable:"true",onDragStart:()=>j(t.id),onDragOver:o,onDragLeave:N,onDrop:k,className:v,children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap cursor-pointer",onClick:()=>i(t),children:e.jsx("div",{className:"text-sm font-medium text-white",children:t.name})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-slate-300 cursor-pointer",onClick:()=>i(t),children:t.responsible}),e.jsx("td",{className:`px-6 py-4 whitespace-nowrap text-sm cursor-pointer ${u?"text-red-400 font-bold":"text-slate-300"}`,onClick:()=>i(t),children:b(t.deadline)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap cursor-pointer",onClick:()=>i(t),children:e.jsx(de,{status:t.status})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap cursor-pointer",onClick:()=>i(t),children:e.jsx("div",{className:"flex flex-wrap items-center gap-1.5",children:t.tags&&t.tags.length>0?t.tags.map(a=>e.jsx("span",{className:"px-2 py-0.5 text-xs rounded bg-slate-700 text-slate-300",children:a},a)):e.jsx("span",{className:"text-slate-500 text-xs",children:"—"})})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-slate-300 cursor-pointer",onClick:()=>i(t),children:!t.attachments||t.attachments.length===0?e.jsx("span",{className:"px-2 py-1 text-xs font-medium rounded bg-red-500/20 text-red-400",children:"Нет вложений"}):e.jsx("div",{className:"flex items-center space-x-2",children:t.attachments.map(a=>a.url?e.jsx("a",{href:a.url,target:"_blank",rel:"noopener noreferrer",title:a.title||a.url,children:e.jsx(J,{className:"w-5 h-5 text-slate-400 hover:text-blue-400"})},a.id):a.directus_files_id?e.jsx("div",{title:a.directus_files_id.title,children:e.jsx(B,{className:"w-5 h-5 text-slate-400"})},a.id):null)})}),e.jsx("td",{className:"px-6 py-4 text-sm text-slate-400 max-w-sm truncate cursor-pointer",onClick:()=>i(t),children:t.notes||"—"})]})},xe=({projects:t,onRowClick:i,sortConfig:p,onSort:j,draggedProjectId:S,onDragStart:r,onDrop:h})=>{const u=[{key:"name",label:"ДЕЛО / ПРОЕКТ",isSortable:!0},{key:"responsible",label:"ОТВЕТСТВЕННЫЙ",isSortable:!0},{key:"deadline",label:"ДЕДЛАЙН",isSortable:!0},{key:"status",label:"СТАТУС",isSortable:!0},{key:"tags",label:"ТЕГИ",isSortable:!1},{key:"attachments",label:"ТАБЛИЦА",isSortable:!1},{key:"notes",label:"ПРИМЕЧАНИЯ",isSortable:!1}],b=({columnKey:o})=>p.key!==o?null:p.direction==="asc"?e.jsx(ee,{className:"w-3 h-3 ml-1.5 inline-block"}):e.jsx(te,{className:"w-3 h-3 ml-1.5 inline-block"});return t.length===0?e.jsxs("div",{className:"text-center py-16 bg-slate-800 rounded-lg shadow-md",children:[e.jsx(Z,{className:"mx-auto h-12 w-12 text-slate-500"}),e.jsx("h3",{className:"mt-2 text-lg font-medium text-white",children:"Проекты не найдены"}),e.jsx("p",{className:"mt-1 text-sm text-slate-400",children:"Попробуйте изменить фильтры или добавить новый проект."})]}):e.jsx("div",{className:"bg-slate-800 shadow-md rounded-lg overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-slate-700",children:[e.jsx("thead",{className:"bg-slate-700/50",children:e.jsx("tr",{children:u.map(({key:o,label:N,isSortable:k})=>e.jsx("th",{scope:"col",className:`px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider whitespace-nowrap ${k?"cursor-pointer hover:text-slate-200":""}`,onClick:()=>k&&j(o),children:e.jsxs("div",{className:"flex items-center",children:[N,k&&e.jsx(b,{columnKey:o})]})},o))})}),e.jsx("tbody",{className:"bg-slate-800 divide-y divide-slate-700",children:t.map(o=>e.jsx(me,{project:o,onRowClick:i,isDragged:S===o.id,onDragStart:r,onDrop:h},o.id))})]})})})},ue=({project:t,onClose:i,onSave:p,onDelete:j})=>{const S={...t,history:t.history||[],tags:t.tags||[],attachments:t.attachments||[],notes:t.notes||""},[r,h]=x.useState(S),[u,b]=x.useState(""),[o,N]=x.useState(!1),k=x.useRef(null);x.useEffect(()=>{const s={...t,history:t.history||[],tags:t.tags||[],attachments:t.attachments||[],notes:t.notes||""};h(s)},[t]);const v=s=>{const{name:c,value:f}=s.target;h(F=>({...F,[c]:f}))},a=s=>{const c=s.target.value;if(c){const f=new Date(r.deadline);f.setFullYear(parseInt(c.substring(0,4),10)),f.setMonth(parseInt(c.substring(5,7),10)-1),f.setDate(parseInt(c.substring(8,10),10)),h(F=>({...F,deadline:f.toISOString()}))}},l=s=>{s.key==="Enter"&&u.trim()!==""&&(s.preventDefault(),(r.tags||[]).includes(u.trim())||h(c=>({...c,tags:[...c.tags||[],u.trim()]})),b(""))},d=s=>{h(c=>({...c,tags:(c.tags||[]).filter(f=>f!==s)}))},m=s=>{h(c=>({...c,attachments:(c.attachments||[]).filter(f=>f.id!==s)}))},y=async s=>{var f;const c=(f=s.target.files)==null?void 0:f[0];if(c)try{N(!0);const F=await ne(c),M={id:-1,projects_id:t.id,directus_files_id:F};h(E=>({...E,attachments:[...E.attachments||[],M]}))}catch(F){console.error("File upload failed:",F),alert("Не удалось загрузить файл.")}finally{N(!1)}s.target&&(s.target.value="")},A=()=>{const s={...r,attachments:(r.attachments||[]).map(c=>{var f;return(f=c.directus_files_id)==null?void 0:f.id}).filter(c=>!!c)};p(s)},$=()=>{window.confirm(`Вы уверены, что хотите удалить проект "${t.name}"?`)&&j(t.id)},D="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5",L=e.jsxs("div",{className:"flex justify-between w-full",children:[e.jsxs("button",{type:"button",onClick:$,className:"inline-flex items-center gap-2 text-red-400 hover:text-red-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors",children:[e.jsx(K,{className:"w-4 h-4"}),"Удалить проект"]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{type:"button",onClick:i,className:"text-white bg-slate-600 hover:bg-slate-700 border border-slate-500 focus:outline-none focus:ring-4 focus:ring-slate-500 font-medium rounded-lg text-sm px-5 py-2.5",children:"Отмена"}),e.jsx("button",{type:"button",onClick:A,className:"text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5",children:"Сохранить изменения"})]})]});return e.jsx(re,{title:"Детали проекта",onClose:i,footer:L,children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"name",className:"block mb-2 text-sm font-medium text-white",children:"Название проекта"}),e.jsx("input",{type:"text",id:"name",name:"name",value:r.name,onChange:v,className:D})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"responsible",className:"block mb-2 text-sm font-medium text-white",children:"Ответственный"}),e.jsx("input",{type:"text",id:"responsible",name:"responsible",value:r.responsible,onChange:v,className:D})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"deadline",className:"block mb-2 text-sm font-medium text-white",children:"Дедлайн"}),e.jsx("input",{type:"date",id:"deadline",name:"deadline",value:r.deadline?r.deadline.split("T")[0]:"",onChange:a,className:D})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"status",className:"block mb-2 text-sm font-medium text-white",children:"Статус"}),e.jsx("select",{id:"status",name:"status",value:r.status,onChange:v,className:D,children:Object.values(C).map(s=>e.jsx("option",{value:s,children:s},s))})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"tags",className:"block mb-2 text-sm font-medium text-white",children:"Теги"}),e.jsxs("div",{className:"flex flex-wrap gap-2 items-center p-2 border border-slate-600 rounded-lg bg-slate-700",children:[(r.tags||[]).map(s=>e.jsxs("span",{className:"flex items-center bg-blue-900 text-blue-300 text-xs font-medium px-2 py-1 rounded-full",children:[s,e.jsx("button",{onClick:()=>d(s),className:"ml-1.5 -mr-0.5 p-0.5 rounded-full hover:bg-blue-700",children:e.jsx(se,{className:"w-3 h-3"})})]},s)),e.jsx("input",{type:"text",value:u,onChange:s=>b(s.target.value),onKeyDown:l,placeholder:"Добавить тег...",className:"bg-transparent focus:outline-none flex-grow text-sm min-w-[100px] text-white"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"notes",className:"block mb-2 text-sm font-medium text-white",children:"Заметки"}),e.jsx("textarea",{id:"notes",name:"notes",rows:4,value:r.notes,onChange:v,className:D})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-md font-semibold text-slate-200 mb-2",children:"Вложения"}),r.attachments.length>0&&e.jsx("ul",{className:"border border-slate-700 rounded-lg divide-y divide-slate-700 mb-4",children:r.attachments.map(s=>{var c;return e.jsxs("li",{className:"p-3 flex items-center justify-between hover:bg-slate-700/50",children:[e.jsxs("div",{className:"flex items-center min-w-0",children:[s.url?e.jsx(J,{className:"w-5 h-5 mr-3 text-slate-400 flex-shrink-0"}):e.jsx(B,{className:"w-5 h-5 mr-3 text-slate-400 flex-shrink-0"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-white truncate",children:s.title||((c=s.directus_files_id)==null?void 0:c.title)}),s.directus_files_id&&e.jsxs("p",{className:"text-xs text-slate-400 truncate",children:[s.directus_files_id.type,", ",(s.directus_files_id.filesize/1024).toFixed(2)," KB"]})]})]}),e.jsx("button",{onClick:()=>m(s.id),className:"ml-2 p-1.5 rounded-full hover:bg-red-900/50 text-slate-400 hover:text-red-400",children:e.jsx(K,{className:"w-4 h-4"})})]},s.id)})}),e.jsxs("div",{className:"space-y-3 p-3 bg-slate-700/50 rounded-lg",children:[e.jsx("button",{type:"button",onClick:()=>{var s;return(s=k.current)==null?void 0:s.click()},disabled:o,className:"w-full flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium text-white bg-slate-600 border border-slate-500 rounded-lg shadow-sm hover:bg-slate-500 disabled:bg-slate-500 disabled:cursor-wait",children:o?e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"w-5 h-5 animate-spin"}),e.jsx("span",{children:"Загрузка..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(ae,{className:"w-5 h-5"}),e.jsx("span",{children:"Загрузить файл"})]})}),e.jsx("input",{type:"file",ref:k,onChange:y,className:"hidden"})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-md font-semibold text-slate-200 mb-2",children:"История изменений"}),r.history&&r.history.length>0?e.jsx("ul",{className:"space-y-2 text-sm",children:r.history.map(s=>e.jsxs("li",{className:"flex items-center text-slate-400",children:[e.jsx(le,{className:"w-4 h-4 mr-2 flex-shrink-0"}),new Date(s.timestamp).toLocaleString("ru-RU")," - ",e.jsx("span",{className:"font-medium text-slate-300 mx-1",children:s.user})," - ",s.action]},s.id))}):e.jsx("p",{className:"text-sm text-slate-400 italic",children:"История изменений пока пуста"})]})]})})},ge=()=>{const{projects:t,projectOrder:i,setProjectOrder:p,loading:j,error:S,addProject:r,updateProject:h,deleteProject:u}=ce(),[b,o]=x.useState(null),[N,k]=x.useState(()=>localStorage.getItem("projectSearchText")||""),[v,a]=x.useState(()=>localStorage.getItem("projectStatusFilter")||"all"),[l,d]=x.useState(()=>localStorage.getItem("projectAttachmentFilter")||"all"),[m,y]=x.useState(()=>{const g=localStorage.getItem("projectSortConfig");return g?JSON.parse(g):{key:"deadline",direction:"asc"}}),[A,$]=x.useState(null);x.useEffect(()=>{localStorage.setItem("projectSearchText",N),localStorage.setItem("projectStatusFilter",v),localStorage.setItem("projectAttachmentFilter",l),localStorage.setItem("projectSortConfig",JSON.stringify(m))},[N,v,l,m]);const D=x.useMemo(()=>{const g=new Map(t.map(n=>[n.id,n]));let w=i.map(n=>g.get(n)).filter(n=>n!==void 0);const _=new Set(w.map(n=>n.id));t.forEach(n=>{_.has(n.id)||w.push(n)});let P=[...w];if(N){const n=N.toLowerCase();P=P.filter(I=>I.name.toLowerCase().includes(n)||I.responsible.toLowerCase().includes(n)||I.tags&&I.tags.some(O=>O.toLowerCase().includes(n)))}return v!=="all"&&(P=P.filter(n=>n.status===v)),l!=="all"&&(P=P.filter(n=>{var O,T;const I=n.attachments&&n.attachments.length>0;switch(l){case"file":return((O=n.attachments)==null?void 0:O.some(U=>U.directus_files_id))||!1;case"link":return((T=n.attachments)==null?void 0:T.some(U=>U.url))||!1;case"none":return!I;default:return!0}})),m.key&&P.sort((n,I)=>{const O=n[m.key],T=I[m.key];return O<T?m.direction==="asc"?-1:1:O>T?m.direction==="asc"?1:-1:0}),P},[t,N,v,l,m,i]),L=g=>{let w="asc";m.key===g&&m.direction==="asc"&&(w="desc"),y({key:g,direction:w})},s=async()=>{const g={name:"Новый проект",responsible:"Не назначен",deadline:new Date().toISOString(),attachments:[],notes:""},w=await r(g);w&&o(w)},c=async g=>{const{id:w,..._}=g;await h(w,_),o(null)},f=async g=>{await u(g),o(null)},F=x.useCallback(g=>{$(g)},[]),M=x.useCallback(g=>{if(!A)return;const w=D.map(O=>O.id),_=w.indexOf(A),P=w.indexOf(g);if(_===-1||P===-1)return;const n=[...w],[I]=n.splice(_,1);n.splice(P,0,I),y({key:null,direction:"asc"}),p(n),$(null)},[A,D,p]),E=()=>j?e.jsxs("div",{className:"flex justify-center items-center h-64",children:[e.jsx(R,{className:"w-8 h-8 animate-spin text-blue-500"}),e.jsx("p",{className:"ml-4 text-slate-400",children:"Загрузка проектов..."})]}):S?e.jsxs("div",{className:"text-center py-16 bg-red-900/20 border border-red-500/30 rounded-lg",children:[e.jsx("h3",{className:"text-lg font-medium text-red-400",children:"Ошибка при загрузке проектов"}),e.jsx("p",{className:"mt-1 text-sm text-slate-400",children:S}),e.jsx("p",{className:"mt-2 text-xs text-slate-500",children:"Убедитесь, что Directus запущен и конфигурация в `config.ts` верна."})]}):e.jsx(xe,{projects:D,onRowClick:o,sortConfig:m,onSort:L,draggedProjectId:A,onDragStart:F,onDrop:M});return e.jsxs("div",{children:[e.jsx(ie,{onNewProject:s}),e.jsxs("main",{children:[e.jsx(oe,{searchText:N,onSearchTextChange:k,statusFilter:v,onStatusFilterChange:a,attachmentFilter:l,onAttachmentFilterChange:d}),E()]}),b&&e.jsx(ue,{project:b,onClose:()=>o(null),onSave:c,onDelete:f})]})};export{ge as default};
