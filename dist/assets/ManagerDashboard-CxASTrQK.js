import{r as m,i as R,k as V,l as X,m as Y,j as e,P as q,S as z,n as H,F as B,L as J,N as W,o as G,p as Q,q as Z,X as ee,T as U,s as K,t as te,C as se,v as ae}from"./index-B1cMW_6L.js";import{M as le}from"./Modal-ZupYsrpS.js";const ne=()=>{const[t,c]=m.useState([]),[g,b]=m.useState([]),[y,l]=m.useState(!0),[h,x]=m.useState(null),j=m.useCallback(async()=>{try{l(!0);const a=(await R()).map(d=>({...d,attachments:[]}));c(a);const u=localStorage.getItem("projectOrder");if(u){const d=new Set(a.map(I=>I.id)),P=JSON.parse(u).filter(I=>d.has(I));b(P)}else b(a.map(d=>d.id));x(null)}catch(n){x(n.message||"Failed to fetch projects")}finally{l(!1)}},[]);return m.useEffect(()=>{j()},[j]),m.useEffect(()=>{g.length>0&&localStorage.setItem("projectOrder",JSON.stringify(g))},[g]),{projects:t,projectOrder:g,setProjectOrder:b,loading:y,error:h,addProject:async n=>{try{const a=await Y(n);return c(u=>[a,...u]),b(u=>[a.id,...u]),a}catch(a){x(a.message||"Failed to create project");return}},updateProject:async(n,a)=>{try{const u=await X(n,a);c(d=>d.map(P=>P.id===n?u:P))}catch(u){x(u.message||"Failed to update project")}},deleteProject:async n=>{try{await V(n),c(a=>a.filter(u=>u.id!==n)),b(a=>a.filter(u=>u!==n))}catch(a){x(a.message||"Failed to delete project")}},loadProjectAttachments:async n=>(console.warn("Attachments loading is temporarily disabled to avoid M2M issues"),[])}},re=({onNewProject:t})=>e.jsxs("header",{className:"mb-6 flex justify-between items-center flex-wrap gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-white",children:"Дашборд руководителя"}),e.jsx("p",{className:"text-sm sm:text-base text-slate-400",children:"Управляйте текущими проектами, задачами и ресурсами."})]}),e.jsx("div",{children:e.jsxs("button",{onClick:t,className:"inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-slate-800",children:[e.jsx(q,{className:"w-5 h-5"}),e.jsx("span",{children:"Новый проект"})]})})]});var C=(t=>(t.InProgress="в работе",t.Completed="завершено",t.Archived="архив",t))(C||{});const ce=({searchText:t,onSearchTextChange:c,statusFilter:g,onStatusFilterChange:b,attachmentFilter:y,onAttachmentFilterChange:l})=>{const h=[{label:"Все",value:"all",icon:e.jsx(H,{className:"w-4 h-4 mr-1.5"})},{label:"Файл",value:"file",icon:e.jsx(B,{className:"w-4 h-4 mr-1.5"})},{label:"Ссылка",value:"link",icon:e.jsx(J,{className:"w-4 h-4 mr-1.5"})},{label:"Нет",value:"none",icon:e.jsx(W,{className:"w-4 h-4 mr-1.5"})}];return e.jsxs("div",{className:"mb-6 p-4 bg-slate-800 rounded-lg flex flex-col sm:flex-row items-center gap-4 flex-wrap",children:[e.jsxs("div",{className:"relative w-full sm:flex-1 sm:min-w-[250px]",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(z,{className:"h-5 w-5 text-slate-400"})}),e.jsx("input",{type:"text",placeholder:"Поиск по проекту или ответственному...",value:t,onChange:x=>c(x.target.value),className:"bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 p-2.5"})]}),e.jsx("div",{className:"w-full sm:w-auto",children:e.jsxs("select",{value:g,onChange:x=>b(x.target.value),className:"bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5",children:[e.jsx("option",{value:"all",children:"Все статусы"}),e.jsx("option",{value:C.InProgress,children:C.InProgress}),e.jsx("option",{value:C.Completed,children:C.Completed}),e.jsx("option",{value:C.Archived,children:C.Archived})]})}),e.jsx("div",{className:"w-full sm:w-auto flex items-center bg-slate-700 rounded-lg p-1 space-x-1",children:h.map(({label:x,value:j,icon:o})=>e.jsxs("button",{onClick:()=>l(j),className:`flex items-center justify-center w-full sm:w-auto px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${y===j?"bg-blue-600 text-white shadow":"text-slate-300 hover:bg-slate-600 hover:text-white"}`,children:[o,x]},j))})]})},ie=({status:t})=>{const c=()=>{switch(t){case C.InProgress:return"bg-sky-500/20 text-sky-400";case C.Completed:return"bg-green-500/20 text-green-400";case C.Archived:return"bg-slate-500/20 text-slate-400";default:return"bg-slate-700 text-slate-300"}};return e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${c()}`,children:t})},oe=({project:t,onRowClick:c,isDragged:g,onDragStart:b,onDrop:y})=>{const[l,h]=m.useState(!1),x=new Date(t.deadline)<new Date&&t.status!=="завершено"&&t.status!=="архив",j=n=>{const a=new Date(n),u=String(a.getDate()).padStart(2,"0"),d=String(a.getMonth()+1).padStart(2,"0"),P=a.getFullYear();return`${u}.${d}.${P}`},o=n=>{n.preventDefault(),h(!0)},N=n=>{n.preventDefault(),h(!1)},S=n=>{n.preventDefault(),h(!1),y(t.id)},v=["transition-colors",g?"opacity-30":"hover:bg-slate-700/50",l?"border-t-2 border-blue-500":""].join(" ");return e.jsxs("tr",{draggable:"true",onDragStart:()=>b(t.id),onDragOver:o,onDragLeave:N,onDrop:S,className:v,children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap cursor-pointer",onClick:()=>c(t),children:e.jsx("div",{className:"text-sm font-medium text-white",children:t.name})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-slate-300 cursor-pointer",onClick:()=>c(t),children:t.responsible}),e.jsx("td",{className:`px-6 py-4 whitespace-nowrap text-sm cursor-pointer ${x?"text-red-400 font-bold":"text-slate-300"}`,onClick:()=>c(t),children:j(t.deadline)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap cursor-pointer",onClick:()=>c(t),children:e.jsx(ie,{status:t.status})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap cursor-pointer",onClick:()=>c(t),children:e.jsx("div",{className:"flex flex-wrap items-center gap-1.5",children:t.tags&&t.tags.length>0?t.tags.map(n=>e.jsx("span",{className:"px-2 py-0.5 text-xs rounded bg-slate-700 text-slate-300",children:n},n)):e.jsx("span",{className:"text-slate-500 text-xs",children:"—"})})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-slate-300 cursor-pointer",onClick:()=>c(t),children:e.jsx("span",{className:"px-2 py-1 text-xs font-medium rounded bg-red-500/20 text-red-400",children:"Attachments disabled"})}),e.jsx("td",{className:"px-6 py-4 text-sm text-slate-400 max-w-sm truncate cursor-pointer",onClick:()=>c(t),children:t.notes||"—"})]})},de=({projects:t,onRowClick:c,sortConfig:g,onSort:b,draggedProjectId:y,onDragStart:l,onDrop:h})=>{const x=[{key:"name",label:"ДЕЛО / ПРОЕКТ",isSortable:!0},{key:"responsible",label:"ОТВЕТСТВЕННЫЙ",isSortable:!0},{key:"deadline",label:"ДЕДЛАЙН",isSortable:!0},{key:"status",label:"СТАТУС",isSortable:!0},{key:"tags",label:"ТЕГИ",isSortable:!1},{key:"attachments",label:"ТАБЛИЦА",isSortable:!1},{key:"notes",label:"ПРИМЕЧАНИЯ",isSortable:!1}],j=({columnKey:o})=>g.key!==o?null:g.direction==="asc"?e.jsx(Q,{className:"w-3 h-3 ml-1.5 inline-block"}):e.jsx(Z,{className:"w-3 h-3 ml-1.5 inline-block"});return t.length===0?e.jsxs("div",{className:"text-center py-16 bg-slate-800 rounded-lg shadow-md",children:[e.jsx(G,{className:"mx-auto h-12 w-12 text-slate-500"}),e.jsx("h3",{className:"mt-2 text-lg font-medium text-white",children:"Проекты не найдены"}),e.jsx("p",{className:"mt-1 text-sm text-slate-400",children:"Попробуйте изменить фильтры или добавить новый проект."})]}):e.jsx("div",{className:"bg-slate-800 shadow-md rounded-lg overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-slate-700",children:[e.jsx("thead",{className:"bg-slate-700/50",children:e.jsx("tr",{children:x.map(({key:o,label:N,isSortable:S})=>e.jsx("th",{scope:"col",className:`px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider whitespace-nowrap ${S?"cursor-pointer hover:text-slate-200":""}`,onClick:()=>S&&b(o),children:e.jsxs("div",{className:"flex items-center",children:[N,S&&e.jsx(j,{columnKey:o})]})},o))})}),e.jsx("tbody",{className:"bg-slate-800 divide-y divide-slate-700",children:t.map(o=>e.jsx(oe,{project:o,onRowClick:c,isDragged:y===o.id,onDragStart:l,onDrop:h},o.id))})]})})})},me=({project:t,onClose:c,onSave:g,onDelete:b})=>{const y={...t,history:t.history||[],tags:t.tags||[],attachments:t.attachments||[],notes:t.notes||""},[l,h]=m.useState(y),[x,j]=m.useState(""),[o,N]=m.useState(!1),S=m.useRef(null);m.useEffect(()=>{const s={...t,history:t.history||[],tags:t.tags||[],attachments:t.attachments||[],notes:t.notes||""};h(s)},[t]);const v=s=>{const{name:r,value:p}=s.target;h(F=>({...F,[r]:p}))},n=s=>{const r=s.target.value;if(r){const p=new Date(l.deadline);p.setFullYear(parseInt(r.substring(0,4),10)),p.setMonth(parseInt(r.substring(5,7),10)-1),p.setDate(parseInt(r.substring(8,10),10)),h(F=>({...F,deadline:p.toISOString()}))}},a=s=>{s.key==="Enter"&&x.trim()!==""&&(s.preventDefault(),(l.tags||[]).includes(x.trim())||h(r=>({...r,tags:[...r.tags||[],x.trim()]})),j(""))},u=s=>{h(r=>({...r,tags:(r.tags||[]).filter(p=>p!==s)}))},d=s=>{h(r=>({...r,attachments:(r.attachments||[]).filter(p=>p.id!==s)}))},P=async s=>{var p;const r=(p=s.target.files)==null?void 0:p[0];if(r)try{N(!0);const F=await ae(r),E={id:-1,projects_id:t.id,directus_files_id:F};h(M=>({...M,attachments:[...M.attachments||[],E]}))}catch(F){console.error("File upload failed:",F),alert("Не удалось загрузить файл.")}finally{N(!1)}s.target&&(s.target.value="")},I=()=>{const s={...l,attachments:(l.attachments||[]).map(r=>{var p;return(p=r.directus_files_id)==null?void 0:p.id}).filter(r=>!!r)};g(s)},_=()=>{window.confirm(`Вы уверены, что хотите удалить проект "${t.name}"?`)&&b(t.id)},D="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5",$=e.jsxs("div",{className:"flex justify-between w-full",children:[e.jsxs("button",{type:"button",onClick:_,className:"inline-flex items-center gap-2 text-red-400 hover:text-red-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors",children:[e.jsx(U,{className:"w-4 h-4"}),"Удалить проект"]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{type:"button",onClick:c,className:"text-white bg-slate-600 hover:bg-slate-700 border border-slate-500 focus:outline-none focus:ring-4 focus:ring-slate-500 font-medium rounded-lg text-sm px-5 py-2.5",children:"Отмена"}),e.jsx("button",{type:"button",onClick:I,className:"text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5",children:"Сохранить изменения"})]})]});return e.jsx(le,{title:"Детали проекта",onClose:c,footer:$,children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"name",className:"block mb-2 text-sm font-medium text-white",children:"Название проекта"}),e.jsx("input",{type:"text",id:"name",name:"name",value:l.name,onChange:v,className:D})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"responsible",className:"block mb-2 text-sm font-medium text-white",children:"Ответственный"}),e.jsx("input",{type:"text",id:"responsible",name:"responsible",value:l.responsible,onChange:v,className:D})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"deadline",className:"block mb-2 text-sm font-medium text-white",children:"Дедлайн"}),e.jsx("input",{type:"date",id:"deadline",name:"deadline",value:l.deadline?l.deadline.split("T")[0]:"",onChange:n,className:D})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"status",className:"block mb-2 text-sm font-medium text-white",children:"Статус"}),e.jsx("select",{id:"status",name:"status",value:l.status,onChange:v,className:D,children:Object.values(C).map(s=>e.jsx("option",{value:s,children:s},s))})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"tags",className:"block mb-2 text-sm font-medium text-white",children:"Теги"}),e.jsxs("div",{className:"flex flex-wrap gap-2 items-center p-2 border border-slate-600 rounded-lg bg-slate-700",children:[(l.tags||[]).map(s=>e.jsxs("span",{className:"flex items-center bg-blue-900 text-blue-300 text-xs font-medium px-2 py-1 rounded-full",children:[s,e.jsx("button",{onClick:()=>u(s),className:"ml-1.5 -mr-0.5 p-0.5 rounded-full hover:bg-blue-700",children:e.jsx(ee,{className:"w-3 h-3"})})]},s)),e.jsx("input",{type:"text",value:x,onChange:s=>j(s.target.value),onKeyDown:a,placeholder:"Добавить тег...",className:"bg-transparent focus:outline-none flex-grow text-sm min-w-[100px] text-white"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"notes",className:"block mb-2 text-sm font-medium text-white",children:"Заметки"}),e.jsx("textarea",{id:"notes",name:"notes",rows:4,value:l.notes,onChange:v,className:D})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-md font-semibold text-slate-200 mb-2",children:"Вложения"}),l.attachments.length>0&&e.jsx("ul",{className:"border border-slate-700 rounded-lg divide-y divide-slate-700 mb-4",children:l.attachments.map(s=>{var r;return e.jsxs("li",{className:"p-3 flex items-center justify-between hover:bg-slate-700/50",children:[e.jsxs("div",{className:"flex items-center min-w-0",children:[s.url?e.jsx(J,{className:"w-5 h-5 mr-3 text-slate-400 flex-shrink-0"}):e.jsx(B,{className:"w-5 h-5 mr-3 text-slate-400 flex-shrink-0"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-white truncate",children:s.title||((r=s.directus_files_id)==null?void 0:r.title)}),s.directus_files_id&&e.jsxs("p",{className:"text-xs text-slate-400 truncate",children:[s.directus_files_id.type,", ",(s.directus_files_id.filesize/1024).toFixed(2)," KB"]})]})]}),e.jsx("button",{onClick:()=>d(s.id),className:"ml-2 p-1.5 rounded-full hover:bg-red-900/50 text-slate-400 hover:text-red-400",children:e.jsx(U,{className:"w-4 h-4"})})]},s.id)})}),e.jsxs("div",{className:"space-y-3 p-3 bg-slate-700/50 rounded-lg",children:[e.jsx("button",{type:"button",onClick:()=>{var s;return(s=S.current)==null?void 0:s.click()},disabled:o,className:"w-full flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium text-white bg-slate-600 border border-slate-500 rounded-lg shadow-sm hover:bg-slate-500 disabled:bg-slate-500 disabled:cursor-wait",children:o?e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"w-5 h-5 animate-spin"}),e.jsx("span",{children:"Загрузка..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"w-5 h-5"}),e.jsx("span",{children:"Загрузить файл"})]})}),e.jsx("input",{type:"file",ref:S,onChange:P,className:"hidden"})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-md font-semibold text-slate-200 mb-2",children:"История изменений"}),l.history&&l.history.length>0?e.jsx("ul",{className:"space-y-2 text-sm",children:l.history.map(s=>e.jsxs("li",{className:"flex items-center text-slate-400",children:[e.jsx(se,{className:"w-4 h-4 mr-2 flex-shrink-0"}),new Date(s.timestamp).toLocaleString("ru-RU")," - ",e.jsx("span",{className:"font-medium text-slate-300 mx-1",children:s.user})," - ",s.action]},s.id))}):e.jsx("p",{className:"text-sm text-slate-400 italic",children:"История изменений пока пуста"})]})]})})},he=()=>{const{projects:t,projectOrder:c,setProjectOrder:g,loading:b,error:y,addProject:l,updateProject:h,deleteProject:x}=ne(),[j,o]=m.useState(null),[N,S]=m.useState(()=>localStorage.getItem("projectSearchText")||""),[v,n]=m.useState(()=>localStorage.getItem("projectStatusFilter")||"all"),[a,u]=m.useState(()=>localStorage.getItem("projectAttachmentFilter")||"all"),[d,P]=m.useState(()=>{const f=localStorage.getItem("projectSortConfig");return f?JSON.parse(f):{key:"deadline",direction:"asc"}}),[I,_]=m.useState(null);m.useEffect(()=>{localStorage.setItem("projectSearchText",N),localStorage.setItem("projectStatusFilter",v),localStorage.setItem("projectAttachmentFilter",a),localStorage.setItem("projectSortConfig",JSON.stringify(d))},[N,v,a,d]);const D=m.useMemo(()=>{const f=new Map(t.map(i=>[i.id,i]));let w=c.map(i=>f.get(i)).filter(i=>i!==void 0);const A=new Set(w.map(i=>i.id));t.forEach(i=>{A.has(i.id)||w.push(i)});let k=[...w];if(N){const i=N.toLowerCase();k=k.filter(O=>O.name.toLowerCase().includes(i)||O.responsible.toLowerCase().includes(i)||O.tags&&O.tags.some(T=>T.toLowerCase().includes(i)))}return v!=="all"&&(k=k.filter(i=>i.status===v)),a!=="all"&&(k=k.filter(i=>{switch(a){case"file":return!1;case"link":return!1;case"none":return!0;default:return!0}})),d.key&&k.sort((i,O)=>{const T=i[d.key],L=O[d.key];return T<L?d.direction==="asc"?-1:1:T>L?d.direction==="asc"?1:-1:0}),k},[t,N,v,a,d,c]),$=f=>{let w="asc";d.key===f&&d.direction==="asc"&&(w="desc"),P({key:f,direction:w})},s=async()=>{const f={name:"Новый проект",responsible:"Не назначен",deadline:new Date().toISOString(),attachments:[],notes:""},w=await l(f);w&&o(w)},r=async f=>{const{id:w,...A}=f;await h(w,A),o(null)},p=async f=>{await x(f),o(null)},F=m.useCallback(f=>{_(f)},[]),E=m.useCallback(f=>{if(!I)return;const w=D.map(T=>T.id),A=w.indexOf(I),k=w.indexOf(f);if(A===-1||k===-1)return;const i=[...w],[O]=i.splice(A,1);i.splice(k,0,O),P({key:null,direction:"asc"}),g(i),_(null)},[I,D,g]),M=()=>b?e.jsxs("div",{className:"flex justify-center items-center h-64",children:[e.jsx(K,{className:"w-8 h-8 animate-spin text-blue-500"}),e.jsx("p",{className:"ml-4 text-slate-400",children:"Загрузка проектов..."})]}):y?e.jsxs("div",{className:"text-center py-16 bg-red-900/20 border border-red-500/30 rounded-lg",children:[e.jsx("h3",{className:"text-lg font-medium text-red-400",children:"Ошибка при загрузке проектов"}),e.jsx("p",{className:"mt-1 text-sm text-slate-400",children:y}),e.jsx("p",{className:"mt-2 text-xs text-slate-500",children:"Убедитесь, что Directus запущен и конфигурация в `config.ts` верна."})]}):e.jsx(de,{projects:D,onRowClick:o,sortConfig:d,onSort:$,draggedProjectId:I,onDragStart:F,onDrop:E});return e.jsxs("div",{children:[e.jsx(re,{onNewProject:s}),e.jsxs("main",{children:[e.jsx(ce,{searchText:N,onSearchTextChange:S,statusFilter:v,onStatusFilterChange:n,attachmentFilter:a,onAttachmentFilterChange:u}),M()]}),j&&e.jsx(me,{project:j,onClose:()=>o(null),onSave:r,onDelete:p})]})};export{he as default};
