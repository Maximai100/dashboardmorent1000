import{r as x,i as V,k as X,l as Y,m as q,n as z,j as e,P as H,S as W,o as G,F as B,L as J,N as Q,p as Z,q as ee,s as te,X as se,T as K,t as R,v as ae,C as le,w as ne}from"./index-S31F0VYZ.js";import{M as re}from"./Modal-xVoS_Jmh.js";const ce=()=>{const[t,o]=x.useState([]),[p,w]=x.useState([]),[y,n]=x.useState(!0),[h,u]=x.useState(null),b=x.useCallback(async()=>{try{n(!0);const i=await V(),a=await Promise.all(i.map(async j=>{try{const d=await X(j.id);return{...j,attachments:d}}catch(d){return console.warn(`Failed to load attachments for project ${j.id}:`,d),{...j,attachments:[]}}}));o(a);const r=localStorage.getItem("projectOrder");if(r){const j=new Set(a.map(C=>C.id)),d=JSON.parse(r).filter(C=>j.has(C));w(d)}else w(a.map(j=>j.id));u(null)}catch(i){u(i.message||"Failed to fetch projects")}finally{n(!1)}},[]);return x.useEffect(()=>{b()},[b]),x.useEffect(()=>{p.length>0&&localStorage.setItem("projectOrder",JSON.stringify(p))},[p]),{projects:t,projectOrder:p,setProjectOrder:w,loading:y,error:h,addProject:async i=>{try{const a=await z(i);return o(r=>[a,...r]),w(r=>[a.id,...r]),a}catch(a){u(a.message||"Failed to create project");return}},updateProject:async(i,a)=>{try{const r=await q(i,a);o(j=>j.map(d=>d.id===i?r:d))}catch(r){u(r.message||"Failed to update project")}},deleteProject:async i=>{try{await Y(i),o(a=>a.filter(r=>r.id!==i)),w(a=>a.filter(r=>r!==i))}catch(a){u(a.message||"Failed to delete project")}}}},ie=({onNewProject:t})=>e.jsxs("header",{className:"mb-6 flex justify-between items-center flex-wrap gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-white",children:"Дашборд руководителя"}),e.jsx("p",{className:"text-sm sm:text-base text-slate-400",children:"Управляйте текущими проектами, задачами и ресурсами."})]}),e.jsx("div",{children:e.jsxs("button",{onClick:t,className:"inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-slate-800",children:[e.jsx(H,{className:"w-5 h-5"}),e.jsx("span",{children:"Новый проект"})]})})]});var P=(t=>(t.InProgress="в работе",t.Completed="завершено",t.Archived="архив",t))(P||{});const oe=({searchText:t,onSearchTextChange:o,statusFilter:p,onStatusFilterChange:w,attachmentFilter:y,onAttachmentFilterChange:n})=>{const h=[{label:"Все",value:"all",icon:e.jsx(G,{className:"w-4 h-4 mr-1.5"})},{label:"Файл",value:"file",icon:e.jsx(B,{className:"w-4 h-4 mr-1.5"})},{label:"Ссылка",value:"link",icon:e.jsx(J,{className:"w-4 h-4 mr-1.5"})},{label:"Нет",value:"none",icon:e.jsx(Q,{className:"w-4 h-4 mr-1.5"})}];return e.jsxs("div",{className:"mb-6 p-4 bg-slate-800 rounded-lg flex flex-col sm:flex-row items-center gap-4 flex-wrap",children:[e.jsxs("div",{className:"relative w-full sm:flex-1 sm:min-w-[250px]",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(W,{className:"h-5 w-5 text-slate-400"})}),e.jsx("input",{type:"text",placeholder:"Поиск по проекту или ответственному...",value:t,onChange:u=>o(u.target.value),className:"bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 p-2.5"})]}),e.jsx("div",{className:"w-full sm:w-auto",children:e.jsxs("select",{value:p,onChange:u=>w(u.target.value),className:"bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5",children:[e.jsx("option",{value:"all",children:"Все статусы"}),e.jsx("option",{value:P.InProgress,children:P.InProgress}),e.jsx("option",{value:P.Completed,children:P.Completed}),e.jsx("option",{value:P.Archived,children:P.Archived})]})}),e.jsx("div",{className:"w-full sm:w-auto flex items-center bg-slate-700 rounded-lg p-1 space-x-1",children:h.map(({label:u,value:b,icon:m})=>e.jsxs("button",{onClick:()=>n(b),className:`flex items-center justify-center w-full sm:w-auto px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${y===b?"bg-blue-600 text-white shadow":"text-slate-300 hover:bg-slate-600 hover:text-white"}`,children:[m,u]},b))})]})},de=({status:t})=>{const o=()=>{switch(t){case P.InProgress:return"bg-sky-500/20 text-sky-400";case P.Completed:return"bg-green-500/20 text-green-400";case P.Archived:return"bg-slate-500/20 text-slate-400";default:return"bg-slate-700 text-slate-300"}};return e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${o()}`,children:t})},me=({project:t,onRowClick:o,isDragged:p,onDragStart:w,onDrop:y})=>{const[n,h]=x.useState(!1),u=new Date(t.deadline)<new Date&&t.status!=="завершено"&&t.status!=="архив",b=a=>{const r=new Date(a),j=String(r.getDate()).padStart(2,"0"),d=String(r.getMonth()+1).padStart(2,"0"),C=r.getFullYear();return`${j}.${d}.${C}`},m=a=>{a.preventDefault(),h(!0)},v=a=>{a.preventDefault(),h(!1)},S=a=>{a.preventDefault(),h(!1),y(t.id)},i=["transition-colors",p?"opacity-30":"hover:bg-slate-700/50",n?"border-t-2 border-blue-500":""].join(" ");return e.jsxs("tr",{draggable:"true",onDragStart:()=>w(t.id),onDragOver:m,onDragLeave:v,onDrop:S,className:i,children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap cursor-pointer",onClick:()=>o(t),children:e.jsx("div",{className:"text-sm font-medium text-white",children:t.name})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-slate-300 cursor-pointer",onClick:()=>o(t),children:t.responsible}),e.jsx("td",{className:`px-6 py-4 whitespace-nowrap text-sm cursor-pointer ${u?"text-red-400 font-bold":"text-slate-300"}`,onClick:()=>o(t),children:b(t.deadline)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap cursor-pointer",onClick:()=>o(t),children:e.jsx(de,{status:t.status})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap cursor-pointer",onClick:()=>o(t),children:e.jsx("div",{className:"flex flex-wrap items-center gap-1.5",children:t.tags&&t.tags.length>0?t.tags.map(a=>e.jsx("span",{className:"px-2 py-0.5 text-xs rounded bg-slate-700 text-slate-300",children:a},a)):e.jsx("span",{className:"text-slate-500 text-xs",children:"—"})})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-slate-300 cursor-pointer",onClick:()=>o(t),children:!t.attachments||t.attachments.length===0?e.jsx("span",{className:"px-2 py-1 text-xs font-medium rounded bg-red-500/20 text-red-400",children:"Нет вложений"}):e.jsx("div",{className:"flex items-center space-x-2",children:t.attachments.map(a=>a.url?e.jsx("a",{href:a.url,target:"_blank",rel:"noopener noreferrer",title:a.title||a.url,children:e.jsx(J,{className:"w-5 h-5 text-slate-400 hover:text-blue-400"})},a.id):a.directus_files_id?e.jsx("div",{title:a.directus_files_id.title,children:e.jsx(B,{className:"w-5 h-5 text-slate-400"})},a.id):null)})}),e.jsx("td",{className:"px-6 py-4 text-sm text-slate-400 max-w-sm truncate cursor-pointer",onClick:()=>o(t),children:t.notes||"—"})]})},xe=({projects:t,onRowClick:o,sortConfig:p,onSort:w,draggedProjectId:y,onDragStart:n,onDrop:h})=>{const u=[{key:"name",label:"ДЕЛО / ПРОЕКТ",isSortable:!0},{key:"responsible",label:"ОТВЕТСТВЕННЫЙ",isSortable:!0},{key:"deadline",label:"ДЕДЛАЙН",isSortable:!0},{key:"status",label:"СТАТУС",isSortable:!0},{key:"tags",label:"ТЕГИ",isSortable:!1},{key:"attachments",label:"ТАБЛИЦА",isSortable:!1},{key:"notes",label:"ПРИМЕЧАНИЯ",isSortable:!1}],b=({columnKey:m})=>p.key!==m?null:p.direction==="asc"?e.jsx(ee,{className:"w-3 h-3 ml-1.5 inline-block"}):e.jsx(te,{className:"w-3 h-3 ml-1.5 inline-block"});return t.length===0?e.jsxs("div",{className:"text-center py-16 bg-slate-800 rounded-lg shadow-md",children:[e.jsx(Z,{className:"mx-auto h-12 w-12 text-slate-500"}),e.jsx("h3",{className:"mt-2 text-lg font-medium text-white",children:"Проекты не найдены"}),e.jsx("p",{className:"mt-1 text-sm text-slate-400",children:"Попробуйте изменить фильтры или добавить новый проект."})]}):e.jsx("div",{className:"bg-slate-800 shadow-md rounded-lg overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-slate-700",children:[e.jsx("thead",{className:"bg-slate-700/50",children:e.jsx("tr",{children:u.map(({key:m,label:v,isSortable:S})=>e.jsx("th",{scope:"col",className:`px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider whitespace-nowrap ${S?"cursor-pointer hover:text-slate-200":""}`,onClick:()=>S&&w(m),children:e.jsxs("div",{className:"flex items-center",children:[v,S&&e.jsx(b,{columnKey:m})]})},m))})}),e.jsx("tbody",{className:"bg-slate-800 divide-y divide-slate-700",children:t.map(m=>e.jsx(me,{project:m,onRowClick:o,isDragged:y===m.id,onDragStart:n,onDrop:h},m.id))})]})})})},ue=({project:t,onClose:o,onSave:p,onDelete:w})=>{const y={...t,history:t.history||[],tags:t.tags||[],attachments:t.attachments||[],notes:t.notes||""},[n,h]=x.useState(y),[u,b]=x.useState(""),[m,v]=x.useState(!1),S=x.useRef(null);x.useEffect(()=>{const s={...t,history:t.history||[],tags:t.tags||[],attachments:t.attachments||[],notes:t.notes||""};h(s)},[t]);const i=s=>{const{name:c,value:f}=s.target;h(F=>({...F,[c]:f}))},a=s=>{const c=s.target.value;if(c){const f=new Date(n.deadline);f.setFullYear(parseInt(c.substring(0,4),10)),f.setMonth(parseInt(c.substring(5,7),10)-1),f.setDate(parseInt(c.substring(8,10),10)),h(F=>({...F,deadline:f.toISOString()}))}},r=s=>{s.key==="Enter"&&u.trim()!==""&&(s.preventDefault(),(n.tags||[]).includes(u.trim())||h(c=>({...c,tags:[...c.tags||[],u.trim()]})),b(""))},j=s=>{h(c=>({...c,tags:(c.tags||[]).filter(f=>f!==s)}))},d=s=>{h(c=>({...c,attachments:(c.attachments||[]).filter(f=>f.id!==s)}))},C=async s=>{var f;const c=(f=s.target.files)==null?void 0:f[0];if(c)try{v(!0);const F=await ne(c),M={id:-1,projects_id:t.id,directus_files_id:F};h(E=>({...E,attachments:[...E.attachments||[],M]}))}catch(F){console.error("File upload failed:",F),alert("Не удалось загрузить файл.")}finally{v(!1)}s.target&&(s.target.value="")},_=()=>{const s={...n,attachments:(n.attachments||[]).map(c=>{var f;return(f=c.directus_files_id)==null?void 0:f.id}).filter(c=>!!c)};p(s)},$=()=>{window.confirm(`Вы уверены, что хотите удалить проект "${t.name}"?`)&&w(t.id)},D="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5",L=e.jsxs("div",{className:"flex justify-between w-full",children:[e.jsxs("button",{type:"button",onClick:$,className:"inline-flex items-center gap-2 text-red-400 hover:text-red-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors",children:[e.jsx(K,{className:"w-4 h-4"}),"Удалить проект"]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{type:"button",onClick:o,className:"text-white bg-slate-600 hover:bg-slate-700 border border-slate-500 focus:outline-none focus:ring-4 focus:ring-slate-500 font-medium rounded-lg text-sm px-5 py-2.5",children:"Отмена"}),e.jsx("button",{type:"button",onClick:_,className:"text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5",children:"Сохранить изменения"})]})]});return e.jsx(re,{title:"Детали проекта",onClose:o,footer:L,children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"name",className:"block mb-2 text-sm font-medium text-white",children:"Название проекта"}),e.jsx("input",{type:"text",id:"name",name:"name",value:n.name,onChange:i,className:D})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"responsible",className:"block mb-2 text-sm font-medium text-white",children:"Ответственный"}),e.jsx("input",{type:"text",id:"responsible",name:"responsible",value:n.responsible,onChange:i,className:D})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"deadline",className:"block mb-2 text-sm font-medium text-white",children:"Дедлайн"}),e.jsx("input",{type:"date",id:"deadline",name:"deadline",value:n.deadline?n.deadline.split("T")[0]:"",onChange:a,className:D})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"status",className:"block mb-2 text-sm font-medium text-white",children:"Статус"}),e.jsx("select",{id:"status",name:"status",value:n.status,onChange:i,className:D,children:Object.values(P).map(s=>e.jsx("option",{value:s,children:s},s))})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"tags",className:"block mb-2 text-sm font-medium text-white",children:"Теги"}),e.jsxs("div",{className:"flex flex-wrap gap-2 items-center p-2 border border-slate-600 rounded-lg bg-slate-700",children:[(n.tags||[]).map(s=>e.jsxs("span",{className:"flex items-center bg-blue-900 text-blue-300 text-xs font-medium px-2 py-1 rounded-full",children:[s,e.jsx("button",{onClick:()=>j(s),className:"ml-1.5 -mr-0.5 p-0.5 rounded-full hover:bg-blue-700",children:e.jsx(se,{className:"w-3 h-3"})})]},s)),e.jsx("input",{type:"text",value:u,onChange:s=>b(s.target.value),onKeyDown:r,placeholder:"Добавить тег...",className:"bg-transparent focus:outline-none flex-grow text-sm min-w-[100px] text-white"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"notes",className:"block mb-2 text-sm font-medium text-white",children:"Заметки"}),e.jsx("textarea",{id:"notes",name:"notes",rows:4,value:n.notes,onChange:i,className:D})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-md font-semibold text-slate-200 mb-2",children:"Вложения"}),n.attachments.length>0&&e.jsx("ul",{className:"border border-slate-700 rounded-lg divide-y divide-slate-700 mb-4",children:n.attachments.map(s=>{var c;return e.jsxs("li",{className:"p-3 flex items-center justify-between hover:bg-slate-700/50",children:[e.jsxs("div",{className:"flex items-center min-w-0",children:[s.url?e.jsx(J,{className:"w-5 h-5 mr-3 text-slate-400 flex-shrink-0"}):e.jsx(B,{className:"w-5 h-5 mr-3 text-slate-400 flex-shrink-0"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-white truncate",children:s.title||((c=s.directus_files_id)==null?void 0:c.title)}),s.directus_files_id&&e.jsxs("p",{className:"text-xs text-slate-400 truncate",children:[s.directus_files_id.type,", ",(s.directus_files_id.filesize/1024).toFixed(2)," KB"]})]})]}),e.jsx("button",{onClick:()=>d(s.id),className:"ml-2 p-1.5 rounded-full hover:bg-red-900/50 text-slate-400 hover:text-red-400",children:e.jsx(K,{className:"w-4 h-4"})})]},s.id)})}),e.jsxs("div",{className:"space-y-3 p-3 bg-slate-700/50 rounded-lg",children:[e.jsx("button",{type:"button",onClick:()=>{var s;return(s=S.current)==null?void 0:s.click()},disabled:m,className:"w-full flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium text-white bg-slate-600 border border-slate-500 rounded-lg shadow-sm hover:bg-slate-500 disabled:bg-slate-500 disabled:cursor-wait",children:m?e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"w-5 h-5 animate-spin"}),e.jsx("span",{children:"Загрузка..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(ae,{className:"w-5 h-5"}),e.jsx("span",{children:"Загрузить файл"})]})}),e.jsx("input",{type:"file",ref:S,onChange:C,className:"hidden"})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-md font-semibold text-slate-200 mb-2",children:"История изменений"}),n.history&&n.history.length>0?e.jsx("ul",{className:"space-y-2 text-sm",children:n.history.map(s=>e.jsxs("li",{className:"flex items-center text-slate-400",children:[e.jsx(le,{className:"w-4 h-4 mr-2 flex-shrink-0"}),new Date(s.timestamp).toLocaleString("ru-RU")," - ",e.jsx("span",{className:"font-medium text-slate-300 mx-1",children:s.user})," - ",s.action]},s.id))}):e.jsx("p",{className:"text-sm text-slate-400 italic",children:"История изменений пока пуста"})]})]})})},ge=()=>{const{projects:t,projectOrder:o,setProjectOrder:p,loading:w,error:y,addProject:n,updateProject:h,deleteProject:u}=ce(),[b,m]=x.useState(null),[v,S]=x.useState(()=>localStorage.getItem("projectSearchText")||""),[i,a]=x.useState(()=>localStorage.getItem("projectStatusFilter")||"all"),[r,j]=x.useState(()=>localStorage.getItem("projectAttachmentFilter")||"all"),[d,C]=x.useState(()=>{const g=localStorage.getItem("projectSortConfig");return g?JSON.parse(g):{key:"deadline",direction:"asc"}}),[_,$]=x.useState(null);x.useEffect(()=>{localStorage.setItem("projectSearchText",v),localStorage.setItem("projectStatusFilter",i),localStorage.setItem("projectAttachmentFilter",r),localStorage.setItem("projectSortConfig",JSON.stringify(d))},[v,i,r,d]);const D=x.useMemo(()=>{const g=new Map(t.map(l=>[l.id,l]));let N=o.map(l=>g.get(l)).filter(l=>l!==void 0);const A=new Set(N.map(l=>l.id));t.forEach(l=>{A.has(l.id)||N.push(l)});let k=[...N];if(v){const l=v.toLowerCase();k=k.filter(I=>I.name.toLowerCase().includes(l)||I.responsible.toLowerCase().includes(l)||I.tags&&I.tags.some(O=>O.toLowerCase().includes(l)))}return i!=="all"&&(k=k.filter(l=>l.status===i)),r!=="all"&&(k=k.filter(l=>{var O,T;const I=l.attachments&&l.attachments.length>0;switch(r){case"file":return((O=l.attachments)==null?void 0:O.some(U=>U.directus_files_id))||!1;case"link":return((T=l.attachments)==null?void 0:T.some(U=>U.url))||!1;case"none":return!I;default:return!0}})),d.key&&k.sort((l,I)=>{const O=l[d.key],T=I[d.key];return O<T?d.direction==="asc"?-1:1:O>T?d.direction==="asc"?1:-1:0}),k},[t,v,i,r,d,o]),L=g=>{let N="asc";d.key===g&&d.direction==="asc"&&(N="desc"),C({key:g,direction:N})},s=async()=>{const g={name:"Новый проект",responsible:"Не назначен",deadline:new Date().toISOString(),attachments:[],notes:""},N=await n(g);N&&m(N)},c=async g=>{const{id:N,...A}=g;await h(N,A),m(null)},f=async g=>{await u(g),m(null)},F=x.useCallback(g=>{$(g)},[]),M=x.useCallback(g=>{if(!_)return;const N=D.map(O=>O.id),A=N.indexOf(_),k=N.indexOf(g);if(A===-1||k===-1)return;const l=[...N],[I]=l.splice(A,1);l.splice(k,0,I),C({key:null,direction:"asc"}),p(l),$(null)},[_,D,p]),E=()=>w?e.jsxs("div",{className:"flex justify-center items-center h-64",children:[e.jsx(R,{className:"w-8 h-8 animate-spin text-blue-500"}),e.jsx("p",{className:"ml-4 text-slate-400",children:"Загрузка проектов..."})]}):y?e.jsxs("div",{className:"text-center py-16 bg-red-900/20 border border-red-500/30 rounded-lg",children:[e.jsx("h3",{className:"text-lg font-medium text-red-400",children:"Ошибка при загрузке проектов"}),e.jsx("p",{className:"mt-1 text-sm text-slate-400",children:y}),e.jsx("p",{className:"mt-2 text-xs text-slate-500",children:"Убедитесь, что Directus запущен и конфигурация в `config.ts` верна."})]}):e.jsx(xe,{projects:D,onRowClick:m,sortConfig:d,onSort:L,draggedProjectId:_,onDragStart:F,onDrop:M});return e.jsxs("div",{children:[e.jsx(ie,{onNewProject:s}),e.jsxs("main",{children:[e.jsx(oe,{searchText:v,onSearchTextChange:S,statusFilter:i,onStatusFilterChange:a,attachmentFilter:r,onAttachmentFilterChange:j}),E()]}),b&&e.jsx(ue,{project:b,onClose:()=>m(null),onSave:c,onDelete:f})]})};export{ge as default};
