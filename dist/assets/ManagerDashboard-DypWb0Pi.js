import{r as m,i as V,k as X,l as Y,m as q,j as e,P as z,S as H,n as G,F as B,L as J,N as Q,o as W,p as Z,q as ee,X as te,T as K,s as R,t as se,C as ae,v as le}from"./index-BmzAcdDN.js";import{M as ne}from"./Modal-Cl1Mmpvr.js";const re=()=>{const[t,o]=m.useState([]),[p,j]=m.useState([]),[v,c]=m.useState(!0),[h,x]=m.useState(null),b=m.useCallback(async()=>{try{c(!0);const l=await V();o(l);const a=localStorage.getItem("projectOrder");if(a){const n=new Set(l.map(u=>u.id)),P=JSON.parse(a).filter(u=>n.has(u));j(P)}else j(l.map(n=>n.id));x(null)}catch(l){x(l.message||"Failed to fetch projects")}finally{c(!1)}},[]);return m.useEffect(()=>{b()},[b]),m.useEffect(()=>{p.length>0&&localStorage.setItem("projectOrder",JSON.stringify(p))},[p]),{projects:t,projectOrder:p,setProjectOrder:j,loading:v,error:h,addProject:async l=>{try{const a=await q(l);return o(n=>[a,...n]),j(n=>[a.id,...n]),a}catch(a){x(a.message||"Failed to create project");return}},updateProject:async(l,a)=>{try{const n=await Y(l,a);o(P=>P.map(u=>u.id===l?n:u))}catch(n){x(n.message||"Failed to update project")}},deleteProject:async l=>{try{await X(l),o(a=>a.filter(n=>n.id!==l)),j(a=>a.filter(n=>n!==l))}catch(a){x(a.message||"Failed to delete project")}}}},ce=({onNewProject:t})=>e.jsxs("header",{className:"mb-6 flex justify-between items-center flex-wrap gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl sm:text-3xl font-bold text-white",children:"Дашборд руководителя"}),e.jsx("p",{className:"text-sm sm:text-base text-slate-400",children:"Управляйте текущими проектами, задачами и ресурсами."})]}),e.jsx("div",{children:e.jsxs("button",{onClick:t,className:"inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-slate-800",children:[e.jsx(z,{className:"w-5 h-5"}),e.jsx("span",{children:"Новый проект"})]})})]});var k=(t=>(t.InProgress="в работе",t.Completed="завершено",t.Archived="архив",t))(k||{});const ie=({searchText:t,onSearchTextChange:o,statusFilter:p,onStatusFilterChange:j,attachmentFilter:v,onAttachmentFilterChange:c})=>{const h=[{label:"Все",value:"all",icon:e.jsx(G,{className:"w-4 h-4 mr-1.5"})},{label:"Файл",value:"file",icon:e.jsx(B,{className:"w-4 h-4 mr-1.5"})},{label:"Ссылка",value:"link",icon:e.jsx(J,{className:"w-4 h-4 mr-1.5"})},{label:"Нет",value:"none",icon:e.jsx(Q,{className:"w-4 h-4 mr-1.5"})}];return e.jsxs("div",{className:"mb-6 p-4 bg-slate-800 rounded-lg flex flex-col sm:flex-row items-center gap-4 flex-wrap",children:[e.jsxs("div",{className:"relative w-full sm:flex-1 sm:min-w-[250px]",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx(H,{className:"h-5 w-5 text-slate-400"})}),e.jsx("input",{type:"text",placeholder:"Поиск по проекту или ответственному...",value:t,onChange:x=>o(x.target.value),className:"bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 p-2.5"})]}),e.jsx("div",{className:"w-full sm:w-auto",children:e.jsxs("select",{value:p,onChange:x=>j(x.target.value),className:"bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5",children:[e.jsx("option",{value:"all",children:"Все статусы"}),e.jsx("option",{value:k.InProgress,children:k.InProgress}),e.jsx("option",{value:k.Completed,children:k.Completed}),e.jsx("option",{value:k.Archived,children:k.Archived})]})}),e.jsx("div",{className:"w-full sm:w-auto flex items-center bg-slate-700 rounded-lg p-1 space-x-1",children:h.map(({label:x,value:b,icon:d})=>e.jsxs("button",{onClick:()=>c(b),className:`flex items-center justify-center w-full sm:w-auto px-3 py-1.5 text-sm font-medium rounded-md transition-colors ${v===b?"bg-blue-600 text-white shadow":"text-slate-300 hover:bg-slate-600 hover:text-white"}`,children:[d,x]},b))})]})},oe=({status:t})=>{const o=()=>{switch(t){case k.InProgress:return"bg-sky-500/20 text-sky-400";case k.Completed:return"bg-green-500/20 text-green-400";case k.Archived:return"bg-slate-500/20 text-slate-400";default:return"bg-slate-700 text-slate-300"}};return e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${o()}`,children:t})},de=({project:t,onRowClick:o,isDragged:p,onDragStart:j,onDrop:v})=>{const[c,h]=m.useState(!1),x=new Date(t.deadline)<new Date&&t.status!=="завершено"&&t.status!=="архив",b=a=>{const n=new Date(a),P=String(n.getDate()).padStart(2,"0"),u=String(n.getMonth()+1).padStart(2,"0"),O=n.getFullYear();return`${P}.${u}.${O}`},d=a=>{a.preventDefault(),h(!0)},N=a=>{a.preventDefault(),h(!1)},y=a=>{a.preventDefault(),h(!1),v(t.id)},l=["transition-colors",p?"opacity-30":"hover:bg-slate-700/50",c?"border-t-2 border-blue-500":""].join(" ");return e.jsxs("tr",{draggable:"true",onDragStart:()=>j(t.id),onDragOver:d,onDragLeave:N,onDrop:y,className:l,children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap cursor-pointer",onClick:()=>o(t),children:e.jsx("div",{className:"text-sm font-medium text-white",children:t.name})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-slate-300 cursor-pointer",onClick:()=>o(t),children:t.responsible}),e.jsx("td",{className:`px-6 py-4 whitespace-nowrap text-sm cursor-pointer ${x?"text-red-400 font-bold":"text-slate-300"}`,onClick:()=>o(t),children:b(t.deadline)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap cursor-pointer",onClick:()=>o(t),children:e.jsx(oe,{status:t.status})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap cursor-pointer",onClick:()=>o(t),children:e.jsx("div",{className:"flex flex-wrap items-center gap-1.5",children:t.tags&&t.tags.length>0?t.tags.map(a=>e.jsx("span",{className:"px-2 py-0.5 text-xs rounded bg-slate-700 text-slate-300",children:a},a)):e.jsx("span",{className:"text-slate-500 text-xs",children:"—"})})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-slate-300 cursor-pointer",onClick:()=>o(t),children:!t.attachments||t.attachments.length===0?e.jsx("span",{className:"px-2 py-1 text-xs font-medium rounded bg-red-500/20 text-red-400",children:"Нет вложений"}):e.jsx("div",{className:"flex items-center space-x-2",children:t.attachments.map(a=>a.url?e.jsx("a",{href:a.url,target:"_blank",rel:"noopener noreferrer",title:a.title||a.url,children:e.jsx(J,{className:"w-5 h-5 text-slate-400 hover:text-blue-400"})},a.id):a.directus_files_id?e.jsx("div",{title:a.directus_files_id.title,children:e.jsx(B,{className:"w-5 h-5 text-slate-400"})},a.id):null)})}),e.jsx("td",{className:"px-6 py-4 text-sm text-slate-400 max-w-sm truncate cursor-pointer",onClick:()=>o(t),children:t.notes||"—"})]})},me=({projects:t,onRowClick:o,sortConfig:p,onSort:j,draggedProjectId:v,onDragStart:c,onDrop:h})=>{const x=[{key:"name",label:"ДЕЛО / ПРОЕКТ",isSortable:!0},{key:"responsible",label:"ОТВЕТСТВЕННЫЙ",isSortable:!0},{key:"deadline",label:"ДЕДЛАЙН",isSortable:!0},{key:"status",label:"СТАТУС",isSortable:!0},{key:"tags",label:"ТЕГИ",isSortable:!1},{key:"attachments",label:"ТАБЛИЦА",isSortable:!1},{key:"notes",label:"ПРИМЕЧАНИЯ",isSortable:!1}],b=({columnKey:d})=>p.key!==d?null:p.direction==="asc"?e.jsx(Z,{className:"w-3 h-3 ml-1.5 inline-block"}):e.jsx(ee,{className:"w-3 h-3 ml-1.5 inline-block"});return t.length===0?e.jsxs("div",{className:"text-center py-16 bg-slate-800 rounded-lg shadow-md",children:[e.jsx(W,{className:"mx-auto h-12 w-12 text-slate-500"}),e.jsx("h3",{className:"mt-2 text-lg font-medium text-white",children:"Проекты не найдены"}),e.jsx("p",{className:"mt-1 text-sm text-slate-400",children:"Попробуйте изменить фильтры или добавить новый проект."})]}):e.jsx("div",{className:"bg-slate-800 shadow-md rounded-lg overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-slate-700",children:[e.jsx("thead",{className:"bg-slate-700/50",children:e.jsx("tr",{children:x.map(({key:d,label:N,isSortable:y})=>e.jsx("th",{scope:"col",className:`px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider whitespace-nowrap ${y?"cursor-pointer hover:text-slate-200":""}`,onClick:()=>y&&j(d),children:e.jsxs("div",{className:"flex items-center",children:[N,y&&e.jsx(b,{columnKey:d})]})},d))})}),e.jsx("tbody",{className:"bg-slate-800 divide-y divide-slate-700",children:t.map(d=>e.jsx(de,{project:d,onRowClick:o,isDragged:v===d.id,onDragStart:c,onDrop:h},d.id))})]})})})},xe=({project:t,onClose:o,onSave:p,onDelete:j})=>{const v={...t,history:t.history||[],tags:t.tags||[],attachments:t.attachments||[],notes:t.notes||""},[c,h]=m.useState(v),[x,b]=m.useState(""),[d,N]=m.useState(!1),y=m.useRef(null);m.useEffect(()=>{const s={...t,history:t.history||[],tags:t.tags||[],attachments:t.attachments||[],notes:t.notes||""};h(s)},[t]);const l=s=>{const{name:i,value:f}=s.target;h(D=>({...D,[i]:f}))},a=s=>{const i=s.target.value;if(i){const f=new Date(c.deadline);f.setFullYear(parseInt(i.substring(0,4),10)),f.setMonth(parseInt(i.substring(5,7),10)-1),f.setDate(parseInt(i.substring(8,10),10)),h(D=>({...D,deadline:f.toISOString()}))}},n=s=>{s.key==="Enter"&&x.trim()!==""&&(s.preventDefault(),(c.tags||[]).includes(x.trim())||h(i=>({...i,tags:[...i.tags||[],x.trim()]})),b(""))},P=s=>{h(i=>({...i,tags:(i.tags||[]).filter(f=>f!==s)}))},u=s=>{h(i=>({...i,attachments:(i.attachments||[]).filter(f=>f.id!==s)}))},O=async s=>{var f;const i=(f=s.target.files)==null?void 0:f[0];if(i)try{N(!0);const D=await le(i),M={id:-1,projects_id:t.id,directus_files_id:D};h(E=>({...E,attachments:[...E.attachments||[],M]}))}catch(D){console.error("File upload failed:",D),alert("Не удалось загрузить файл.")}finally{N(!1)}s.target&&(s.target.value="")},_=()=>{const s={...c,attachments:(c.attachments||[]).map(i=>{var f;return(f=i.directus_files_id)==null?void 0:f.id}).filter(i=>!!i)};p(s)},$=()=>{window.confirm(`Вы уверены, что хотите удалить проект "${t.name}"?`)&&j(t.id)},I="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5",L=e.jsxs("div",{className:"flex justify-between w-full",children:[e.jsxs("button",{type:"button",onClick:$,className:"inline-flex items-center gap-2 text-red-400 hover:text-red-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors",children:[e.jsx(K,{className:"w-4 h-4"}),"Удалить проект"]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{type:"button",onClick:o,className:"text-white bg-slate-600 hover:bg-slate-700 border border-slate-500 focus:outline-none focus:ring-4 focus:ring-slate-500 font-medium rounded-lg text-sm px-5 py-2.5",children:"Отмена"}),e.jsx("button",{type:"button",onClick:_,className:"text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5",children:"Сохранить изменения"})]})]});return e.jsx(ne,{title:"Детали проекта",onClose:o,footer:L,children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"name",className:"block mb-2 text-sm font-medium text-white",children:"Название проекта"}),e.jsx("input",{type:"text",id:"name",name:"name",value:c.name,onChange:l,className:I})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"responsible",className:"block mb-2 text-sm font-medium text-white",children:"Ответственный"}),e.jsx("input",{type:"text",id:"responsible",name:"responsible",value:c.responsible,onChange:l,className:I})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"deadline",className:"block mb-2 text-sm font-medium text-white",children:"Дедлайн"}),e.jsx("input",{type:"date",id:"deadline",name:"deadline",value:c.deadline?c.deadline.split("T")[0]:"",onChange:a,className:I})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"status",className:"block mb-2 text-sm font-medium text-white",children:"Статус"}),e.jsx("select",{id:"status",name:"status",value:c.status,onChange:l,className:I,children:Object.values(k).map(s=>e.jsx("option",{value:s,children:s},s))})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"tags",className:"block mb-2 text-sm font-medium text-white",children:"Теги"}),e.jsxs("div",{className:"flex flex-wrap gap-2 items-center p-2 border border-slate-600 rounded-lg bg-slate-700",children:[(c.tags||[]).map(s=>e.jsxs("span",{className:"flex items-center bg-blue-900 text-blue-300 text-xs font-medium px-2 py-1 rounded-full",children:[s,e.jsx("button",{onClick:()=>P(s),className:"ml-1.5 -mr-0.5 p-0.5 rounded-full hover:bg-blue-700",children:e.jsx(te,{className:"w-3 h-3"})})]},s)),e.jsx("input",{type:"text",value:x,onChange:s=>b(s.target.value),onKeyDown:n,placeholder:"Добавить тег...",className:"bg-transparent focus:outline-none flex-grow text-sm min-w-[100px] text-white"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"notes",className:"block mb-2 text-sm font-medium text-white",children:"Заметки"}),e.jsx("textarea",{id:"notes",name:"notes",rows:4,value:c.notes,onChange:l,className:I})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-md font-semibold text-slate-200 mb-2",children:"Вложения"}),c.attachments.length>0&&e.jsx("ul",{className:"border border-slate-700 rounded-lg divide-y divide-slate-700 mb-4",children:c.attachments.map(s=>{var i;return e.jsxs("li",{className:"p-3 flex items-center justify-between hover:bg-slate-700/50",children:[e.jsxs("div",{className:"flex items-center min-w-0",children:[s.url?e.jsx(J,{className:"w-5 h-5 mr-3 text-slate-400 flex-shrink-0"}):e.jsx(B,{className:"w-5 h-5 mr-3 text-slate-400 flex-shrink-0"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-white truncate",children:s.title||((i=s.directus_files_id)==null?void 0:i.title)}),s.directus_files_id&&e.jsxs("p",{className:"text-xs text-slate-400 truncate",children:[s.directus_files_id.type,", ",(s.directus_files_id.filesize/1024).toFixed(2)," KB"]})]})]}),e.jsx("button",{onClick:()=>u(s.id),className:"ml-2 p-1.5 rounded-full hover:bg-red-900/50 text-slate-400 hover:text-red-400",children:e.jsx(K,{className:"w-4 h-4"})})]},s.id)})}),e.jsxs("div",{className:"space-y-3 p-3 bg-slate-700/50 rounded-lg",children:[e.jsx("button",{type:"button",onClick:()=>{var s;return(s=y.current)==null?void 0:s.click()},disabled:d,className:"w-full flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium text-white bg-slate-600 border border-slate-500 rounded-lg shadow-sm hover:bg-slate-500 disabled:bg-slate-500 disabled:cursor-wait",children:d?e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"w-5 h-5 animate-spin"}),e.jsx("span",{children:"Загрузка..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(se,{className:"w-5 h-5"}),e.jsx("span",{children:"Загрузить файл"})]})}),e.jsx("input",{type:"file",ref:y,onChange:O,className:"hidden"})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-md font-semibold text-slate-200 mb-2",children:"История изменений"}),c.history&&c.history.length>0?e.jsx("ul",{className:"space-y-2 text-sm",children:c.history.map(s=>e.jsxs("li",{className:"flex items-center text-slate-400",children:[e.jsx(ae,{className:"w-4 h-4 mr-2 flex-shrink-0"}),new Date(s.timestamp).toLocaleString("ru-RU")," - ",e.jsx("span",{className:"font-medium text-slate-300 mx-1",children:s.user})," - ",s.action]},s.id))}):e.jsx("p",{className:"text-sm text-slate-400 italic",children:"История изменений пока пуста"})]})]})})},fe=()=>{const{projects:t,projectOrder:o,setProjectOrder:p,loading:j,error:v,addProject:c,updateProject:h,deleteProject:x}=re(),[b,d]=m.useState(null),[N,y]=m.useState(()=>localStorage.getItem("projectSearchText")||""),[l,a]=m.useState(()=>localStorage.getItem("projectStatusFilter")||"all"),[n,P]=m.useState(()=>localStorage.getItem("projectAttachmentFilter")||"all"),[u,O]=m.useState(()=>{const g=localStorage.getItem("projectSortConfig");return g?JSON.parse(g):{key:"deadline",direction:"asc"}}),[_,$]=m.useState(null);m.useEffect(()=>{localStorage.setItem("projectSearchText",N),localStorage.setItem("projectStatusFilter",l),localStorage.setItem("projectAttachmentFilter",n),localStorage.setItem("projectSortConfig",JSON.stringify(u))},[N,l,n,u]);const I=m.useMemo(()=>{const g=new Map(t.map(r=>[r.id,r]));let w=o.map(r=>g.get(r)).filter(r=>r!==void 0);const A=new Set(w.map(r=>r.id));t.forEach(r=>{A.has(r.id)||w.push(r)});let S=[...w];if(N){const r=N.toLowerCase();S=S.filter(C=>C.name.toLowerCase().includes(r)||C.responsible.toLowerCase().includes(r)||C.tags&&C.tags.some(F=>F.toLowerCase().includes(r)))}return l!=="all"&&(S=S.filter(r=>r.status===l)),n!=="all"&&(S=S.filter(r=>{var F,T;const C=r.attachments&&r.attachments.length>0;switch(n){case"file":return((F=r.attachments)==null?void 0:F.some(U=>U.directus_files_id))||!1;case"link":return((T=r.attachments)==null?void 0:T.some(U=>U.url))||!1;case"none":return!C;default:return!0}})),u.key&&S.sort((r,C)=>{const F=r[u.key],T=C[u.key];return F<T?u.direction==="asc"?-1:1:F>T?u.direction==="asc"?1:-1:0}),S},[t,N,l,n,u,o]),L=g=>{let w="asc";u.key===g&&u.direction==="asc"&&(w="desc"),O({key:g,direction:w})},s=async()=>{const g={name:"Новый проект",responsible:"Не назначен",deadline:new Date().toISOString(),attachments:[],notes:""},w=await c(g);w&&d(w)},i=async g=>{const{id:w,...A}=g;await h(w,A),d(null)},f=async g=>{await x(g),d(null)},D=m.useCallback(g=>{$(g)},[]),M=m.useCallback(g=>{if(!_)return;const w=I.map(F=>F.id),A=w.indexOf(_),S=w.indexOf(g);if(A===-1||S===-1)return;const r=[...w],[C]=r.splice(A,1);r.splice(S,0,C),O({key:null,direction:"asc"}),p(r),$(null)},[_,I,p]),E=()=>j?e.jsxs("div",{className:"flex justify-center items-center h-64",children:[e.jsx(R,{className:"w-8 h-8 animate-spin text-blue-500"}),e.jsx("p",{className:"ml-4 text-slate-400",children:"Загрузка проектов..."})]}):v?e.jsxs("div",{className:"text-center py-16 bg-red-900/20 border border-red-500/30 rounded-lg",children:[e.jsx("h3",{className:"text-lg font-medium text-red-400",children:"Ошибка при загрузке проектов"}),e.jsx("p",{className:"mt-1 text-sm text-slate-400",children:v}),e.jsx("p",{className:"mt-2 text-xs text-slate-500",children:"Убедитесь, что Directus запущен и конфигурация в `config.ts` верна."})]}):e.jsx(me,{projects:I,onRowClick:d,sortConfig:u,onSort:L,draggedProjectId:_,onDragStart:D,onDrop:M});return e.jsxs("div",{children:[e.jsx(ce,{onNewProject:s}),e.jsxs("main",{children:[e.jsx(ie,{searchText:N,onSearchTextChange:y,statusFilter:l,onStatusFilterChange:a,attachmentFilter:n,onAttachmentFilterChange:P}),E()]}),b&&e.jsx(xe,{project:b,onClose:()=>d(null),onSave:i,onDelete:f})]})};export{fe as default};
