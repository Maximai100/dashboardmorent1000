# Исправление проблемы с файлами проектов

## Проблема
При добавлении нового файла к проекту:
1. Новый файл заменяет предыдущий в Directus
2. В приложении не отображается ни один файл

## Причина
Проблема была в обработке M2M связи между проектами и файлами:
1. При сохранении файла не учитывались существующие attachments
2. Тип `directus_files_id` мог быть как строкой (ID), так и объектом (полные данные файла)
3. Не отправлялись флаги удаления для удаленных attachments

## Внесенные исправления

### 1. Обновлен тип ProjectAttachment
**Файл:** `types/manager.ts`

```typescript
export interface ProjectAttachment {
    id: number;
    projects_id: string | number;
    directus_files_id?: DirectusFile | string; // Теперь может быть и строкой, и объектом
    url?: string;
    URL?: string | null;
    title?: string;
}
```

### 2. Исправлена функция handleSaveChanges
**Файл:** `components/manager/ProjectDetailModal.tsx`

Теперь функция:
- Правильно обрабатывает существующие attachments
- Добавляет новые attachments
- Отмечает удаленные attachments флагом `_delete`
- Корректно извлекает ID файла из объекта или строки

### 3. Исправлено отображение файлов
**Файл:** `components/manager/ProjectDetailModal.tsx`

Теперь код правильно обрабатывает оба варианта `directus_files_id`:
- Когда это строка (ID файла)
- Когда это объект (полные данные файла)

### 4. Обновлен тип AttachmentPayload
**Файл:** `components/manager/ProjectDetailModal.tsx`

```typescript
type AttachmentPayload = {
    id?: number;
    url?: string | null;
    title?: string | null;
    directus_files_id?: string | null;
    projects_id?: string | number | null;
    _delete?: boolean; // Флаг для удаления
}
```

### 5. Исправлены запросы к Directus API
**Файл:** `services/directus.ts`

Проблема: Directus не возвращает вложенные данные файлов при запросе M2M связей.

Решение: После получения проектов/attachments, дополнительно загружаем полные данные файлов:
- `getProjects()` - загружает файлы для всех проектов
- `getProjectAttachments()` - загружает файлы для конкретного проекта
- `updateProject()` - загружает файлы после обновления

Это гарантирует, что `directus_files_id` всегда будет объектом с полными данными файла.

## Как проверить исправление

1. Откройте проект в менеджере проектов
2. Добавьте первый файл - он должен отобразиться
3. Добавьте второй файл - оба файла должны отображаться
4. Удалите один файл - должен остаться только один
5. Сохраните проект
6. Перезагрузите страницу - все файлы должны остаться на месте

## Дополнительные проверки

### Проверка в Directus
1. Откройте Directus Admin Panel
2. Перейдите в коллекцию `projects_files` (junction table)
3. Убедитесь, что для каждого файла есть отдельная запись
4. Проверьте, что `projects_id` и `directus_files_id` заполнены корректно

### Проверка в консоли браузера
1. Откройте DevTools (F12)
2. Перейдите на вкладку Network
3. Добавьте файл к проекту
4. Найдите запрос PATCH к `/items/projects/{id}`
5. Проверьте payload - должен содержать массив attachments с правильными данными

## Возможные проблемы

### Если файлы все еще не отображаются
1. Проверьте, что в Directus правильно настроена M2M связь
2. Убедитесь, что junction table называется `projects_files`
3. Проверьте права доступа к коллекции `directus_files`

### Если файлы дублируются
1. Очистите localStorage: `localStorage.clear()`
2. Перезагрузите страницу
3. Проверьте, что в Directus нет дублирующихся записей в junction table

## Структура M2M связи в Directus

```
projects (коллекция)
    ↓
projects_files (junction table)
    ├── id (primary key)
    ├── projects_id (many-to-one → projects)
    ├── directus_files_id (many-to-one → directus_files)
    ├── url (для ссылок)
    └── title (название)
    ↓
directus_files (системная коллекция)
```

## Следующие шаги

После проверки исправлений:
1. Протестируйте на разных проектах
2. Проверьте работу с разными типами файлов (PDF, изображения, документы)
3. Убедитесь, что ссылки (URL attachments) также работают корректно
4. Проверьте производительность при большом количестве файлов
